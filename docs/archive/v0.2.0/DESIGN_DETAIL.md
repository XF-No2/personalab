# PersonaLab æŠ€æœ¯è®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v0.2.1
**åˆ›å»ºæ—¥æœŸ**: 2025-10-13
**æœ€åæ›´æ–°**: 2025-10-14 (éœ€æ±‚æ¾„æ¸…åæ›´æ–°)

---

## ç›®å½•

1. [ç³»ç»Ÿæ€»ç›®æ ‡](#ç³»ç»Ÿæ€»ç›®æ ‡)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
4. [æ•°æ®ç»“æ„è®¾è®¡](#æ•°æ®ç»“æ„è®¾è®¡)
5. [è®°å¿†ç®¡ç†æ¶æ„](#è®°å¿†ç®¡ç†æ¶æ„)
6. [æ ¸å¿ƒäº¤äº’æµç¨‹](#æ ¸å¿ƒäº¤äº’æµç¨‹)
7. [Promptå·¥ç¨‹](#promptå·¥ç¨‹)
8. [äº‹ä»¶åº“ä¸RAG](#äº‹ä»¶åº“ä¸rag)
9. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
10. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)

---

## ç³»ç»Ÿæ€»ç›®æ ‡

å®ç°ä¸€ä¸ªæ”¯æŒ**é•¿ç¯‡ã€é«˜ä¸€è‡´æ€§ã€è§’è‰²å¯æˆé•¿**çš„äº’åŠ¨å™äº‹å¼•æ“ã€‚

### æ ¸å¿ƒé—®é¢˜

è§£å†³LLMåœ¨é•¿å¯¹è¯ä¸­çš„ä¸¤å¤§é—®é¢˜ï¼š
1. **ä¸Šä¸‹æ–‡ç¨€é‡Š** - å¯¹è¯è¶Šé•¿ï¼Œæ—©æœŸçš„é‡è¦ä¿¡æ¯è¢«ç¨€é‡Šï¼ŒLLMé€æ¸"å¿˜è®°"
2. **æŒ‡ä»¤é—å¿˜** - è§’è‰²äººæ ¼ã€è¡Œä¸ºå‡†åˆ™åœ¨é•¿å¯¹è¯ä¸­é€æ¸è¢«å¿½ç•¥

### è§£å†³æ–¹æ¡ˆ

é€šè¿‡**ä¼šè¯å®ä¾‹éš”ç¦» + åŠ¨æ€äººæ ¼ç®¡ç† + RAGå¢å¼ºè®°å¿†**ï¼š
- ä¼šè¯å®ä¾‹ï¼ˆConversation Instanceï¼‰- ç‹¬ç«‹çš„çŠ¶æ€éš”ç¦»å®¹å™¨
- Core Memory åŠ¨æ€ç®¡ç† - åˆå§‹äººæ ¼ + æˆé•¿äººæ ¼ï¼Œå®šæœŸæ›´æ–°
- äº‹ä»¶åº“ï¼ˆArchival Memoryï¼‰- å‘é‡æ£€ç´¢å†å²äº‹ä»¶
- ç»“æ„åŒ–Promptå·¥ç¨‹ - å°†äººæ ¼çŠ¶æ€å›ºå®šåœ¨ Prompt å¤´éƒ¨

---

## æ ¸å¿ƒæ¦‚å¿µ

### ä¼šè¯å®ä¾‹ï¼ˆConversation Instanceï¼‰

**å®šä¹‰**ï¼šä¸€ä¸ªç‹¬ç«‹çš„ã€çŠ¶æ€éš”ç¦»çš„å¯¹è¯å®¹å™¨ã€‚

**ç‰¹ç‚¹**ï¼š
- ç”¨æˆ·åˆ›å»ºä¼šè¯å®ä¾‹æ—¶ï¼Œé€‰æ‹©è§’è‰²å’ŒèƒŒæ™¯
- å®ä¾‹å†…å¯ä»¥æœ‰å¤šä¸ªä¼šè¯ï¼ˆæš‚åœ/ç»§ç»­ï¼‰
- è§’è‰²çŠ¶æ€å±äºå®ä¾‹ï¼Œä¸å±äºå…¨å±€
- ä¸åŒå®ä¾‹å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“

**ç±»æ¯”**ï¼š
```
è§’è‰²ï¼šAlserqi

å®ä¾‹Aï¼š"ç›Ÿå‹ä¹‹è·¯"
  - ä¼šè¯1ï¼šåˆæ¬¡è§é¢
  - ä¼šè¯2ï¼šå»ºç«‹ä¿¡ä»»ï¼ˆç»§ç»­å®ä¾‹Aï¼‰
  - ä¼šè¯3ï¼šå…±åŒæˆ˜æ–—ï¼ˆç»§ç»­å®ä¾‹Aï¼‰
  â†’ è§’è‰²çŠ¶æ€ï¼šä¸ç”¨æˆ·æ˜¯ç›Ÿå‹

å®ä¾‹Bï¼š"æ•Œå¯¹ä¹‹è·¯"ï¼ˆç‹¬ç«‹å®ä¾‹ï¼‰
  - ä¼šè¯4ï¼šæ•Œå¯¹ç›¸é‡
  - ä¼šè¯5ï¼šå†²çªå‡çº§ï¼ˆç»§ç»­å®ä¾‹Bï¼‰
  â†’ è§’è‰²çŠ¶æ€ï¼šä¸ç”¨æˆ·æ˜¯æ•Œäºº

ä¸¤ä¸ªå®ä¾‹çš„è§’è‰²çŠ¶æ€å®Œå…¨ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°
```

### äººæ ¼æˆé•¿çš„é€»è¾‘é—­ç¯

```
1. è§’è‰²å½“å‰çŠ¶æ€ï¼ˆbase_persona + evolved_persona + æœ€è¿‘å¯¹è¯è®°å¿†ï¼‰
   â†“
2. äº‹ä»¶è§¦å‘ï¼ˆç”¨æˆ·è¾“å…¥/å‰§æƒ…æ¨è¿›ï¼‰
   â†“
3. è§’è‰²çš„ååº”ï¼ˆæƒ³æ³• + è¡Œä¸ºï¼‰â† LLMç”Ÿæˆ
   â†“
4. å®¢è§‚ç»“æœï¼ˆäº‹å®ï¼‰
   â†“
5. ä¸»è§‚é¢„æœŸ vs å®¢è§‚ç»“æœ â†’ äº§ç”Ÿå·®å¼‚
   â†“
6. å·®å¼‚ç§¯ç´¯åˆ°ä¸€å®šç¨‹åº¦ï¼Œè§¦å‘ evolved_persona æ›´æ–°
   â†“
7. æ–°çš„ evolved_persona â†’ å½±å“åç»­æ‰€æœ‰å¯¹è¯çš„ååº”æ–¹å¼
   â†“
ï¼ˆå¾ªç¯ï¼‰
```

**å…³é”®ç†è§£**ï¼š
- çŠ¶æ€å˜åŒ–ä¸æ˜¯è¡¨é¢æƒ…ç»ªè¡¨è¾¾ï¼Œè€Œæ˜¯**æ„å¤–å¯¼è‡´çš„äººæ ¼å½±å“**
- "è½»è”‘"æ˜¯çŠ¶æ€çš„å¿…ç„¶è¡¨è¾¾ï¼Œä¸æ˜¯çŠ¶æ€å˜åŒ–
- "å…³ç³»ä»é™Œç”Ÿäººå˜ç›Ÿå‹"æ‰æ˜¯çŠ¶æ€å˜åŒ–
- äº‹ä»¶æ˜¯è¿ç»­æµï¼Œä¸æ˜¯ç¦»æ•£è½®æ¬¡

---

## æ¶æ„è®¾è®¡

### æ–‡ä»¶ç»„ç»‡ç»“æ„

```
data/
â”œâ”€â”€ characters/                          # è§’è‰²åº“ï¼ˆå…¨å±€ï¼‰
â”‚   â””â”€â”€ {character_id}/
â”‚       â””â”€â”€ definition.json              # è§’è‰²é™æ€å®šä¹‰
â”‚
â”œâ”€â”€ backgrounds/                         # èƒŒæ™¯åº“ï¼ˆå…¨å±€ï¼‰
â”‚   â””â”€â”€ {background_id}.json             # èƒŒæ™¯å®šä¹‰
â”‚
â”œâ”€â”€ instances/                           # ä¼šè¯å®ä¾‹ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â””â”€â”€ {instance_id}/
â”‚       â”œâ”€â”€ metadata.json                # å®ä¾‹å…ƒæ•°æ®
â”‚       â”œâ”€â”€ character_state.json         # å®ä¾‹çš„è§’è‰²çŠ¶æ€
â”‚       â””â”€â”€ sessions/
â”‚           â”œâ”€â”€ sess_001.jsonl           # ä¼šè¯1
â”‚           â”œâ”€â”€ sess_002.jsonl           # ä¼šè¯2ï¼ˆç»§ç»­å¯¹è¯ï¼‰
â”‚           â””â”€â”€ sess_003.jsonl           # ä¼šè¯3ï¼ˆç»§ç»­å¯¹è¯ï¼‰
â”‚
â”œâ”€â”€ event_library/                       # å…¨å±€äº‹ä»¶åº“
â”‚   â””â”€â”€ chroma_db/                       # å‘é‡æ•°æ®åº“
â”‚       # å­˜å‚¨æ‰€æœ‰äº‹ä»¶ï¼Œå¸¦instance_idå’Œsession_idè¿‡æ»¤æ ‡è®°
â”‚
â””â”€â”€ prompt_templates/                    # Promptæ¨¡æ¿
    â””â”€â”€ default_v1.json
```

### IDå…³è”å…³ç³»

```
è§’è‰²å®šä¹‰ï¼ˆå…¨å±€å”¯ä¸€ï¼‰
  â””â”€â”€ character_id: "alserqi_v1"

ä¼šè¯å®ä¾‹ï¼ˆç‹¬ç«‹éš”ç¦»å®¹å™¨ï¼‰
  â””â”€â”€ instance_id: "inst_001"
      â”œâ”€â”€ character_id: "alserqi_v1"     â† å¼•ç”¨è§’è‰²
      â”œâ”€â”€ background_id: "wasteland"     â† å¼•ç”¨èƒŒæ™¯
      â”œâ”€â”€ character_state.json           â† çŠ¶æ€å±äºå®ä¾‹
      â””â”€â”€ sessions/
          â”œâ”€â”€ sess_001.jsonl
          â”‚   â””â”€â”€ session_id: "sess_001"
          â””â”€â”€ sess_002.jsonl
              â””â”€â”€ session_id: "sess_002"

äº‹ä»¶åº“ï¼ˆå…¨å±€ï¼Œä½†å¸¦æ ‡è®°ï¼‰
  â””â”€â”€ event_id: "evt_inst001_sess001_030"
      â”œâ”€â”€ instance_id: "inst_001"        â† å¿…é¡»ï¼ç”¨äºè¿‡æ»¤
      â”œâ”€â”€ session_id: "sess_001"         â† å¿…é¡»ï¼ç”¨äºè¿½æº¯
      â””â”€â”€ turn: 30                       â† ä¼šè¯å†…ç¬¬å‡ è½®
```

---

## æ•°æ®ç»“æ„è®¾è®¡

### 1. è§’è‰²å®šä¹‰ï¼ˆCharacter Definitionï¼‰

**å­˜å‚¨ä½ç½®**ï¼š`data/characters/{character_id}/definition.json`

**ç”¨é€”**ï¼šè§’è‰²çš„é™æ€å®šä¹‰ï¼Œå…¨å±€å…±äº«

**ç»“æ„ç¤ºä¾‹**ï¼š

```json
{
  "character_id": "alserqi_v1",
  "name": "Alserqi",
  "description": "ä¸€ä¸ªå¯»ä»‡è€…ï¼Œæ›¾ç»çš„ç²¾è‹±æˆ˜å£«ï¼Œå› èƒŒå›è€Œå •å…¥å¤ä»‡ä¹‹è·¯",
  "avatar": "alserqi_avatar.png",
  "base_persona": "æˆ‘æ˜¯ Alserqiï¼Œä¸€ä¸ªå¯»ä»‡è€…ã€‚æ›¾ç»æ˜¯ç»„ç»‡çš„ç²¾è‹±æˆ˜å£«ï¼Œå› å‘ç°çœŸç›¸è¢«èƒŒå›ï¼Œå •å…¥å¤ä»‡ä¹‹è·¯ã€‚æ€§æ ¼å†·é…·ã€åŠ¡å®ï¼Œå¯¹èƒŒå›è€…ç»ä¸åŸè°…ï¼Œä½†å¯¹å°‘æ•°äººä»ä¿æœ‰å¿ è¯šã€‚æˆ‘çš„æ ¸å¿ƒç›®æ ‡æ˜¯æ‘§æ¯èƒŒå›æˆ‘çš„'æ ¸å¿ƒ'ç»„ç»‡ã€‚"
}
```

---

### 2. èƒŒæ™¯å®šä¹‰ï¼ˆBackgroundï¼‰

**å­˜å‚¨ä½ç½®**ï¼š`data/backgrounds/{background_id}.json`

**ç”¨é€”**ï¼šå¯¹è¯åœºæ™¯çš„ä¸–ç•Œè§‚è®¾å®š

**ç»“æ„ç¤ºä¾‹**ï¼š

```json
{
  "background_id": "wasteland_world",
  "name": "åºŸåœŸä¸–ç•Œ",
  "description": "æ ¸æˆ˜åçš„è’èŠœå¤§é™†ï¼Œç§‘æŠ€å€’é€€ï¼Œå¼ºè€…ä¸ºç‹ã€‚èµ„æºåŒ®ä¹ï¼Œä¿¡ä»»æ˜¯æœ€ç¨€ç¼ºçš„è´§å¸ã€‚",
  "world_rules": "æš´åŠ›æ˜¯è§£å†³äº‰ç«¯çš„ä¸»è¦æ‰‹æ®µï¼›ç§‘æŠ€é€€åŒ–åˆ°20ä¸–çºªåˆæ°´å¹³ï¼›å¹¸å­˜è€…èšå±…ç‚¹ç¨€å°‘",
  "initial_context": "ä½ é†’æ¥æ—¶ï¼Œå‘ç°è‡ªå·±èº«å¤„ä¸€ç‰‡åºŸå¢Ÿä¸­ï¼Œè¿œå¤„æœ‰çƒŸé›¾å‡èµ·..."
}
```

---

### 3. ä¼šè¯å®ä¾‹å…ƒæ•°æ®ï¼ˆInstance Metadataï¼‰

**å­˜å‚¨ä½ç½®**ï¼š`instances/{instance_id}/metadata.json`

**ç”¨é€”**ï¼šè®°å½•ä¼šè¯å®ä¾‹çš„åŸºæœ¬ä¿¡æ¯

**ç»“æ„ç¤ºä¾‹**ï¼š

```json
{
  "instance_id": "inst_001",
  "title": "ç›Ÿå‹ä¹‹è·¯",
  "character_id": "alserqi_v1",
  "background_id": "wasteland_world",
  "created_at": "2025-10-01T10:00:00Z",
  "last_active_at": "2025-10-10T15:00:00Z",
  "total_turns": 250,
  "sessions": [
    {
      "session_id": "sess_001",
      "created_at": "2025-10-01T10:00:00Z",
      "turns": 100
    },
    {
      "session_id": "sess_002",
      "created_at": "2025-10-05T14:00:00Z",
      "turns": 150
    }
  ],
  "status": "active"
}
```

---

### 4. è§’è‰²çŠ¶æ€ï¼ˆCharacter Stateï¼‰

**å­˜å‚¨ä½ç½®**ï¼š`instances/{instance_id}/character_state.json`

**ç”¨é€”**ï¼šå­˜å‚¨è§’è‰²åœ¨å½“å‰ä¼šè¯å®ä¾‹çš„çŠ¶æ€ï¼ˆé‡‡ç”¨ Core Memory åŠ¨æ€ç®¡ç†æœºåˆ¶ï¼‰

**ç»“æ„ç¤ºä¾‹**ï¼š

```json
{
  "instance_id": "inst_001",
  "character_id": "alserqi_v1",
  "last_updated_turn": 250,
  "last_maintenance_turn": 240,

  "base_persona": "æˆ‘æ˜¯ Alserqiï¼Œä¸€ä¸ªå¯»ä»‡è€…ã€‚æ›¾ç»æ˜¯ç»„ç»‡çš„ç²¾è‹±æˆ˜å£«ï¼Œå› å‘ç°çœŸç›¸è¢«èƒŒå›ï¼Œå •å…¥å¤ä»‡ä¹‹è·¯ã€‚æ€§æ ¼å†·é…·ã€åŠ¡å®ï¼Œå¯¹èƒŒå›è€…ç»ä¸åŸè°…ï¼Œä½†å¯¹å°‘æ•°äººä»ä¿æœ‰å¿ è¯šã€‚æˆ‘çš„æ ¸å¿ƒç›®æ ‡æ˜¯æ‘§æ¯èƒŒå›æˆ‘çš„'æ ¸å¿ƒ'ç»„ç»‡ã€‚",

  "evolved_persona": "ç»å†äº†ä¸ç”¨æˆ·çš„å¹¶è‚©ä½œæˆ˜ï¼Œæˆ‘å¼€å§‹æ„è¯†åˆ°ä¿¡ä»»å¹¶éå®Œå…¨ä¸å¯èƒ½ã€‚è™½ç„¶ä»ä¿æŒè­¦æƒ•ï¼Œä½†å¯¹ç”¨æˆ·äº§ç”Ÿäº†å¤æ‚çš„æƒ…æ„Ÿâ€”â€”æ—¢æœ‰æˆ˜å‹æƒ…è°Šï¼Œä¹Ÿæœ‰å¯¹å…¶åˆ¤æ–­åŠ›çš„è®¤å¯ã€‚ç»å†å¤šæ¬¡èƒŒå›åï¼Œæˆ‘å­¦ä¼šäº†åœ¨æ„¤æ€’ä¸­ä¿æŒç†æ€§ï¼Œä¸å†ç›²ç›®å†²åŠ¨ã€‚å·¦è‡‚åœ¨æœ€è¿‘çš„æˆ˜æ–—ä¸­å—ä¼¤ï¼Œè¿™è®©æˆ‘æ›´åŠ è°¨æ…ã€‚å½“å‰ç›®æ ‡æ˜¯æ‰¾åˆ°å®‰å…¨å±‹ä¼‘æ•´ï¼ŒåŒæ—¶è”ç³»çº¿äººBè·å–'æ ¸å¿ƒ'çš„æœ€æ–°åŠ¨å‘ã€‚"
}
```

**å…³é”®è¯´æ˜**ï¼š
- `base_persona`ï¼šè§’è‰²çš„åˆå§‹äººæ ¼ï¼Œæ°¸ä¸æ”¹å˜
- `evolved_persona`ï¼šè§’è‰²çš„æˆé•¿äººæ ¼ï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨è§¦å‘æ›´æ–°
- çŸ­æœŸçŠ¶æ€ï¼ˆæƒ…ç»ªã€ä¼¤åŠ¿ã€ç›®æ ‡ï¼‰ç›´æ¥èå…¥ `evolved_persona` çš„è‡ªç„¶æè¿°ä¸­
- ä¸å†ä½¿ç”¨ä¸‰å±‚ç»“æ„ï¼ˆcore_identity/growth_state/current_stateï¼‰

---

### 5. ä¼šè¯æ¶ˆæ¯ï¼ˆSession Messagesï¼‰

**å­˜å‚¨ä½ç½®**ï¼š`instances/{instance_id}/sessions/{session_id}.jsonl`

**ç”¨é€”**ï¼šè®°å½•å®Œæ•´å¯¹è¯å†å²

**æ ¼å¼**ï¼š
- ç¬¬ä¸€è¡Œï¼šmetadataï¼ˆå…ƒæ•°æ®ï¼‰
- åç»­è¡Œï¼šå¯¹è¯æ¶ˆæ¯ï¼ˆuser/assistantäº¤æ›¿ï¼‰

**ç¤ºä¾‹**ï¼š

```jsonl
{"type": "metadata", "session_id": "sess_001", "instance_id": "inst_001", "started_at": "2025-10-01T10:00:00Z"}
{"role": "user", "content": "ä½ è¿™ä¸ªéª—å­ï¼", "turn": 1, "timestamp": "2025-10-01T10:00:05Z"}
{"role": "assistant", "content": "Alserqiå¬äº†ä½ çš„è¯ï¼Œçœ¼ä¸­é—ªè¿‡ä¸€ä¸è½»è”‘...", "turn": 1, "timestamp": "2025-10-01T10:00:20Z"}
{"role": "user", "content": "æˆ‘æœ‰è¯æ®", "turn": 2, "timestamp": "2025-10-01T10:01:00Z"}
{"role": "assistant", "content": "ä»–çœ‹åˆ°æ–‡ä»¶ï¼Œç³å­”å¾®ç¼©...", "turn": 2, "timestamp": "2025-10-01T10:01:15Z"}
```

**ç‰¹ç‚¹**ï¼š
- ç®€å•çš„æ¶ˆæ¯æµæ°´è´¦
- ä¸éœ€è¦archivedæ ‡è®°ï¼ˆä¸ä½¿ç”¨å½’æ¡£æœºåˆ¶ï¼‰
- æ°¸ä¹…ä¿å­˜ï¼Œæ”¯æŒå¯¼å‡ºåŠŸèƒ½

---

### 6. äº‹ä»¶ï¼ˆEventï¼‰

**å­˜å‚¨ä½ç½®**ï¼š`data/event_library/chroma_db/`ï¼ˆå‘é‡æ•°æ®åº“ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨é‡è¦äº‹ä»¶æ‘˜è¦ï¼Œç”¨äºRAGæ£€ç´¢

**ç»“æ„ç¤ºä¾‹**ï¼š

```json
{
  "event_id": "evt_inst001_sess001_030",
  "instance_id": "inst_001",
  "session_id": "sess_001",
  "turn": 30,
  "summary": "ç”¨æˆ·å±•ç¤ºè¯æ®ï¼ŒAlserqiä»æ€€ç–‘è½¬ä¸ºä¿¡ä»»ã€‚å…³ç³»ä»é™Œç”Ÿäººå˜ä¸ºæ½œåœ¨ç›Ÿå‹ã€‚",
  "timestamp": "2025-10-01T10:30:00Z",
  "embedding": [0.1, 0.2, 0.3, ...]
}
```

**å…³é”®å­—æ®µ**ï¼š
- `instance_id` - **å¿…é¡»**ï¼Œç”¨äºRAGæ£€ç´¢æ—¶è¿‡æ»¤ï¼Œé¿å…ä¸åŒå®ä¾‹çš„äº‹ä»¶æ··æ·†
- `session_id` - **å¿…é¡»**ï¼Œç”¨äºè¿½æº¯å’Œè°ƒè¯•
- `turn` - ä¼šè¯å†…çš„ç¬¬å‡ è½®ï¼Œç”¨äºç²¾ç¡®å®šä½
- `summary` - äº‹ä»¶æ‘˜è¦ï¼Œç”± LLM åœ¨ç”¨æˆ·æ‰‹åŠ¨è§¦å‘ Core Memory æ›´æ–°æ—¶ç”Ÿæˆ
- ä¸éœ€è¦ `previous_event`ï¼ˆä¸ä½¿ç”¨é“¾è¡¨ç»“æ„ï¼Œçº¯RAGï¼‰

---

## è®°å¿†ç®¡ç†æ¶æ„

### ä¸‰å±‚è®°å¿†æ¶æ„ï¼ˆå€Ÿé‰´ Letta/MemGPTï¼‰

PersonaLab é‡‡ç”¨ä¸‰å±‚è®°å¿†æ¶æ„ï¼Œç±»ä¼¼äº Letta/MemGPT çš„è®¾è®¡ï¼š

```
PersonaLab è®°å¿†æ¶æ„
â”œâ”€ Core Memoryï¼ˆè§’è‰²äººæ ¼çŠ¶æ€ï¼‰
â”‚   - å­˜å‚¨ä½ç½®ï¼šcharacter_state.json
â”‚   - åŠ è½½ä½ç½®ï¼šPrompt å¤´éƒ¨ 4K åŒºåŸŸ
â”‚   - æ›´æ–°æœºåˆ¶ï¼šã€å¾…è®¾è®¡ã€‘
â”‚
â”œâ”€ Archival Memoryï¼ˆé•¿æœŸäº‹ä»¶åº“ï¼‰
â”‚   - å­˜å‚¨ä½ç½®ï¼šChroma å‘é‡æ•°æ®åº“
â”‚   - è®¿é—®æ–¹å¼ï¼šRAG è¯­ä¹‰æ£€ç´¢
â”‚   - å†™å…¥æ—¶æœºï¼šçŠ¶æ€å˜åŒ–æ—¶å¼‚æ­¥å†™å…¥
â”‚
â””â”€ Recall Memoryï¼ˆæœ€è¿‘å¯¹è¯å†å²ï¼‰
    - å­˜å‚¨ä½ç½®ï¼šä¼šè¯æ–‡ä»¶ï¼ˆ.jsonlï¼‰
    - åŠ è½½ä½ç½®ï¼šPrompt ä¸­é—´ 4K-32K åŒºåŸŸ
    - ç»´æŠ¤æœºåˆ¶ï¼šæ¯æ¬¡ä»æ–‡ä»¶è¯»å–æœ€è¿‘ 30 è½®
```

### Recall Memory ç»´æŠ¤æœºåˆ¶ï¼ˆå·²ç¡®å®šï¼‰

**æ ¸å¿ƒè®¾è®¡**ï¼šç›´æ¥ä»æ–‡ä»¶è¯»å–

```python
# é…ç½®å‚æ•°
RECALL_MEMORY_SIZE = 30  # å›ºå®šå€¼ï¼šLLM æ¯æ¬¡æŸ¥çœ‹æœ€è¿‘ 30 è½®å¯¹è¯

def load_recent_messages(session_file: str) -> list:
    """
    ä» .jsonl æ–‡ä»¶è¯»å–æœ€è¿‘ 30 è½®å¯¹è¯
    æ€§èƒ½ï¼š~50-100ms

    å¦‚æœå¯¹è¯ä¸è¶³ 30 è½®ï¼Œè¿”å›å…¨éƒ¨å¯¹è¯
    """
    with open(session_file, 'r', encoding='utf-8') as f:
        lines = f.readlines()

    # è·³è¿‡ç¬¬ä¸€è¡Œ metadata
    messages = [json.loads(line) for line in lines[1:]]

    # è¿”å›æœ€è¿‘ 30 è½®ï¼ˆ30 è½® = 60 æ¡æ¶ˆæ¯ï¼Œuser + assistantï¼‰
    return messages[-60:] if len(messages) > 60 else messages
```

**å…³é”®ç‚¹**ï¼š
- ä¼šè¯æ–‡ä»¶ï¼ˆ.jsonlï¼‰æ°¸ä¹…ä¿ç•™æ‰€æœ‰å¯¹è¯ï¼Œä¸ç‰©ç†åˆ é™¤
- æ¯æ¬¡ä»æ–‡ä»¶è¯»å–æœ€è¿‘ 30 è½®ï¼ˆæ€§èƒ½æŸå¤± ~50-100msï¼Œå¯æ¥å—ï¼‰
- æ”¯æŒ"å›é€€é‡æ–°ç”Ÿæˆ"åŠŸèƒ½ï¼ˆå•ä¸€æ•°æ®æºï¼Œä¸ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´ï¼‰
- LLM åªéœ€è¦çœ‹æœ€è¿‘ 30 è½®ä½œä¸ºå¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ›´æ—©çš„å¯¹è¯é€šè¿‡ RAG æ£€ç´¢è®¿é—®

---

## Core Memory åŠ¨æ€ç®¡ç†æœºåˆ¶

### è®¾è®¡æ–¹æ¡ˆ

PersonaLab ä¸ä½¿ç”¨ Letta çš„ AI Agent è‡ªç®¡ç†æœºåˆ¶ï¼ˆfunction callingï¼‰ï¼Œè€Œæ˜¯é‡‡ç”¨**å®Œå…¨æ‰‹åŠ¨è§¦å‘**çš„æ–¹å¼ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

**Core Memory ç»„æˆ**ï¼š
```
Core Memory = åˆå§‹äººæ ¼ï¼ˆbase_personaï¼‰+ æˆé•¿äººæ ¼ï¼ˆevolved_personaï¼‰
```

- **åˆå§‹äººæ ¼ï¼ˆbase_personaï¼‰**ï¼šè§’è‰²çš„åº•è‰²ï¼Œæ°¸ä¸æ”¹å˜
- **æˆé•¿äººæ ¼ï¼ˆevolved_personaï¼‰**ï¼šéšç€å¯¹è¯ç»å†è€Œå˜åŒ–ï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨è§¦å‘æ›´æ–°

**å±•ç¤ºç»™ AI çš„å®Œæ•´äººæ ¼**ï¼š
```
å®Œæ•´äººæ ¼ = åˆå§‹äººæ ¼ + æˆé•¿äººæ ¼ + å½“å‰å¯¹è¯å†å²
```

### æ•°æ®ç»“æ„

```json
{
  "base_persona": "æˆ‘æ˜¯ä¸€ä¸ªå¤ä»‡è€…ï¼Œæ›¾ç»æ˜¯è­¦å¯Ÿï¼Œå› å†¤æ¡ˆå…¥ç‹±ã€‚æ€§æ ¼å†·é…·ã€æ‰§ç€ï¼Œå¯¹èƒŒå›è€…ç»ä¸åŸè°…ã€‚",

  "evolved_persona": "ç»å†äº†ä¸ç”¨æˆ·çš„ç›¸å¤„ï¼Œå¼€å§‹æ„è¯†åˆ°ä¸–ç•Œå¹¶ééé»‘å³ç™½ã€‚å¯¹ç”¨æˆ·äº§ç”Ÿäº†å¤æ‚çš„æƒ…æ„Ÿï¼Œæ—¢æœ‰è­¦æƒ•ä¹Ÿæœ‰ä¿¡ä»»ã€‚å­¦ä¼šäº†åœ¨æ„¤æ€’ä¸­ä¿æŒç†æ€§ã€‚"
}
```

### æ›´æ–°æœºåˆ¶

#### è§¦å‘æ—¶æœº

**å®Œå…¨æ‰‹åŠ¨è§¦å‘**ï¼šç”¨æˆ·ç‚¹å‡»"ğŸ§  æ›´æ–°è®°å¿†"æŒ‰é’®
- ç«‹å³è°ƒç”¨ LLM æ›´æ–° `evolved_persona`
- ç”¨æˆ·å®Œå…¨æ§åˆ¶æ›´æ–°æ—¶æœº
- åŒæ­¥æ‰§è¡Œï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆçº¦ 5-10 ç§’ï¼‰

#### å®ç°æ¶æ„

```python
@router.post("/maintenance/core-memory")
async def trigger_core_memory_update(instance_id: str):
    """
    æ‰‹åŠ¨è§¦å‘ Core Memory æ›´æ–°
    ç”¨æˆ·ç‚¹å‡»"ğŸ§  æ›´æ–°è®°å¿†"æŒ‰é’®æ—¶è°ƒç”¨
    """
    # 1. åŠ è½½å½“å‰è§’è‰²çŠ¶æ€
    state = load_character_state(instance_id)

    # 2. åŠ è½½æœ€è¿‘ 30 è½®å¯¹è¯
    recent_messages = load_recent_messages(session_file)

    # 3. è°ƒç”¨ LLM æ›´æ–° evolved_persona
    new_evolved_persona = await llm_update_persona(
        base_persona=state['base_persona'],
        old_evolved_persona=state['evolved_persona'],
        recent_messages=recent_messages
    )

    # 4. ä¿å­˜æ–°çš„ evolved_persona
    state['evolved_persona'] = new_evolved_persona
    state['last_maintenance_turn'] = current_turn
    save_character_state(instance_id, state)

    # 5. åŒæ—¶ç”Ÿæˆå¹¶å†™å…¥äº‹ä»¶æ‘˜è¦
    event_summary = await llm_generate_event_summary(recent_messages)
    await write_event_to_chroma(event_summary, instance_id)

    return {"success": True, "updated_persona": new_evolved_persona}
```

### æ›´æ–°æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"ğŸ§  æ›´æ–°è®°å¿†"æŒ‰é’®
  â†“
å‰ç«¯æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  â†“
åç«¯æ‰§è¡Œï¼š
  â”œâ”€ åŠ è½½å½“å‰è§’è‰²çŠ¶æ€
  â”œâ”€ åŠ è½½æœ€è¿‘ 30 è½®å¯¹è¯
  â”œâ”€ è°ƒç”¨ LLM æ›´æ–° evolved_persona (~5-10ç§’)
  â”œâ”€ ä¿å­˜æ–°çš„ evolved_persona
  â””â”€ ç”Ÿæˆäº‹ä»¶æ‘˜è¦å¹¶å†™å…¥ Chroma
  â†“
è¿”å›å‰ç«¯ï¼Œæ˜¾ç¤º"æ›´æ–°å®Œæˆ"
```

### Prompt ç»„è£…

```
---CHARACTER_PERSONA---
## Base Identity (Immutable Core) ##
{base_persona}

## Evolved State (Growth Through Experience) ##
{evolved_persona}

## Recent Context ##
{æœ€è¿‘ 30 è½®å¯¹è¯}
---

æ³¨æ„ï¼šBase Identity æ˜¯è§’è‰²çš„æœ¬è´¨åº•è‰²ï¼Œæ°¸ä¸æ”¹å˜ã€‚
Evolved State æ˜¯è§’è‰²ç»å†æˆé•¿åçš„çŠ¶æ€ã€‚
è¯·ç»¼åˆè€ƒè™‘ä¸¤è€…å’Œå½“å‰å¯¹è¯ä¸Šä¸‹æ–‡æ¥ç”Ÿæˆè§’è‰²çš„ååº”ã€‚
```

### å…³é”®ç‰¹ç‚¹

1. **ç®€å•æ˜äº†**ï¼šåªæœ‰ä¸¤ä¸ªå­—æ®µï¼ˆbase_persona + evolved_personaï¼‰ï¼Œé€»è¾‘æ¸…æ™°
2. **å®Œå…¨æ‰‹åŠ¨è§¦å‘**ï¼šç”±ç”¨æˆ·å†³å®šä½•æ—¶æ›´æ–°ï¼Œä¸è‡ªåŠ¨è§¦å‘
3. **æˆæœ¬å¯æ§**ï¼šåªåœ¨ç”¨æˆ·éœ€è¦æ—¶è°ƒç”¨ LLMï¼ŒèŠ‚çœæˆæœ¬
4. **ç”¨æˆ·å¯æ§**ï¼šç”¨æˆ·å®Œå…¨æ§åˆ¶äººæ ¼æ›´æ–°æ—¶æœºï¼Œç¬¦åˆé¢„æœŸ
5. **æ”¯æŒå›é€€åŠŸèƒ½**ï¼šä¸ä¼šå‡ºç°"å›é€€å¯¹è¯åäººæ ¼çŠ¶æ€ä¸ä¸€è‡´"çš„é—®é¢˜

---

## æ ¸å¿ƒäº¤äº’æµç¨‹

### ä¸€æ¬¡å®Œæ•´äº¤äº’ï¼ˆæ•´åˆç‰ˆï¼‰

**æ€§èƒ½ç›®æ ‡**ï¼š
- æ€»è€—æ—¶ï¼š< 30ç§’
- éLLMè€—æ—¶ï¼š< 2ç§’
- LLMè€—æ—¶ï¼š15-20ç§’

**æµç¨‹**ï¼š

```
ç”¨æˆ·è¾“å…¥ï¼š"ä½ è¿˜è®°å¾—æˆ‘è¯´çš„è¯å—ï¼Ÿ"
  â†“
[1] è¿½åŠ æ¶ˆæ¯åˆ°ä¼šè¯æ–‡ä»¶ (~50ms)
  append_to_file("instances/{instance_id}/sessions/{session_id}.jsonl", user_message)
  â†“
[2] å¹¶è¡ŒåŠ è½½æ•°æ®ï¼ˆæ€»è€—æ—¶å–æœ€æ…¢çš„ï¼‰
  await asyncio.gather(
    rag_query_with_timeout(user_input, instance_id),  # ~500-1500ms
    load_character_state(instance_id),                # ~50ms (åŒ…å« base_persona + evolved_persona)
    load_background(background_id),                   # ~50ms
    load_recent_messages(session_file)                # ~50-100ms (ä»æ–‡ä»¶è¯»å–æœ€è¿‘ 30 è½®)
  )
  å¹¶è¡Œè€—æ—¶ï¼šmax(1500, 50, 50, 100) = ~1500ms
  â†“
[3] ç»„è£…Prompt (~100ms)
  prompt = build_prompt(
    base_persona=state['base_persona'],
    evolved_persona=state['evolved_persona'],
    background=background,
    rag_events=rag_events,
    recent_messages=recent_messages,
    user_input=user_input
  )
  â†“
[4] LLM APIè°ƒç”¨ (~15-20ç§’ï¼Œæµå¼è¾“å‡º)
  async for chunk in llm.generate_stream(prompt):
      websocket.send(chunk)  # å®æ—¶å‘é€åˆ°å‰ç«¯
  â†“
[5] è§£æLLMè¾“å‡º (~50ms)
  narrative = extract_narrative(response)
  # AI åªè¿”å›å™äº‹å†…å®¹ï¼Œä¸è¿”å›çŠ¶æ€æ›´æ–°
  â†“
[6] è¿½åŠ AIå›å¤åˆ°ä¼šè¯æ–‡ä»¶ (~50ms)
  append_to_file("sessions/{session_id}.jsonl", assistant_message)
  â†“
[7] è¿”å›å‰ç«¯
  websocket.send({"type": "done"})

æ€»è®¡ï¼ˆéLLMï¼‰ï¼š~1.75ç§’ âœ… (æ¯”åŸè®¾è®¡å¢åŠ  ~100msï¼Œå¯æ¥å—)
```

### å…³é”®å˜åŒ–

1. **å–æ¶ˆå†…å­˜ç¼“å­˜**ï¼šæ¯æ¬¡ä»æ–‡ä»¶è¯»å–æœ€è¿‘ 30 è½®å¯¹è¯ï¼ˆæ€§èƒ½æŸå¤± ~100msï¼Œå¯æ¥å—ï¼‰
2. **å•ä¸€æ•°æ®æº**ï¼šåªç»´æŠ¤ .jsonl æ–‡ä»¶ï¼Œæ”¯æŒ"å›é€€é‡æ–°ç”Ÿæˆ"åŠŸèƒ½
3. **å–æ¶ˆå®šæœŸç»´æŠ¤**ï¼šCore Memory å®Œå…¨ç”±ç”¨æˆ·æ‰‹åŠ¨è§¦å‘æ›´æ–°
4. **AI åªè¿”å›å™äº‹**ï¼šä¸å†æœ‰ `state_update`ï¼Œç®€åŒ–è®¾è®¡
5. **ç®€åŒ–æµç¨‹**ï¼šåˆ é™¤ç»´æŠ¤ä»»åŠ¡è°ƒåº¦å™¨ï¼Œæµç¨‹æ›´æ¸…æ™°

---

## Promptå·¥ç¨‹

### Promptæ¨¡æ¿ç»“æ„

**è®¾è®¡åŸåˆ™**ï¼šæ¨¡å—åŒ–ã€æ¸…æ™°ã€ç®€æ´

```
---SYSTEM_INSTRUCTION---
## System Role ##
ä½ æ˜¯ä¸€ä¸ªç¬¬ä¸‰äººç§°å™äº‹è€…ï¼Œæè¿°ä¸»è§’[è§’è‰²å]çš„è¡Œä¸ºã€æƒ³æ³•å’Œé­é‡ã€‚
ç”¨æˆ·çš„è¾“å…¥å¯èƒ½æ˜¯ï¼š
1. å¯¹ä¸»è§’è¯´çš„è¯ï¼ˆå¯¹è¯ï¼‰
2. å¯¹å‰§æƒ…çš„æ¨åŠ¨ï¼ˆä¾‹å¦‚ï¼š"è¿™æ—¶ï¼Œè§’è‰²Bå‡ºç°äº†"ï¼‰
3. å¯¹ä¸–ç•Œçš„æè¿°ï¼ˆä¾‹å¦‚ï¼š"çªç„¶ä¸‹èµ·äº†æš´é›¨"ï¼‰
ä½ éœ€è¦æ ¹æ®ä¸»è§’çš„å½“å‰çŠ¶æ€å’Œäººæ ¼ç‰¹è´¨ï¼Œç”Ÿæˆä¸»è§’çš„ååº”ã€‚
---

---JAILBREAK_PREVENTION---
## Critical Rules ##
ä½ å¿…é¡»ä¸¥æ ¼ä¿æŒè§’è‰²äººè®¾ï¼Œä¸å¾—è„±ç¦»è§’è‰²è®¾å®šã€‚
---

---BACKGROUND_CONTEXT---
## World Setting ##
{{background_description}}
{{world_rules}}
---

---CHARACTER_PERSONA---
## Base Identity (Immutable Core) ##
{{base_persona}}

## Evolved State (Growth Through Experience) ##
{{evolved_persona}}

æ³¨æ„ï¼šBase Identity æ˜¯è§’è‰²çš„æœ¬è´¨åº•è‰²ï¼Œæ°¸ä¸æ”¹å˜ã€‚
Evolved State æ˜¯è§’è‰²ç»å†æˆé•¿åçš„çŠ¶æ€ã€‚
è¯·ç»¼åˆè€ƒè™‘ä¸¤è€…å’Œå½“å‰å¯¹è¯ä¸Šä¸‹æ–‡æ¥ç”Ÿæˆè§’è‰²çš„ååº”ã€‚
---

---RELEVANT_PAST_EVENTS---
## Relevant Past Events (RAG Retrieved) ##
{{rag_events_formatted}}
---

---RECENT_CONVERSATION---
## Recent Conversation ##
{{recent_messages}}
---

---USER_INPUT---
## User's Latest Input ##
{{user_input}}
---

---TASK_INSTRUCTIONS---
è¯·æ ¹æ®è§’è‰²äººæ ¼å’Œå½“å‰æƒ…å¢ƒï¼Œç”Ÿæˆè§’è‰²çš„å™äº‹å›åº”ã€‚

åªéœ€è¦è¿”å›å™äº‹å†…å®¹ï¼Œç”¨ <narrative> æ ‡ç­¾åŒ…è£¹ï¼š

<narrative>
è§’è‰²çš„è¡Œä¸ºã€å¯¹è¯ã€å†…å¿ƒæƒ³æ³•...
</narrative>
---

{{AI_GENERATION_STARTS_HERE}}
```

### å…³é”®å˜åŒ–

1. **ç®€åŒ–äººæ ¼æè¿°**ï¼šåªæœ‰ `base_persona` + `evolved_persona`
2. **åˆ é™¤çŠ¶æ€æ›´æ–°è¦æ±‚**ï¼šAI ä¸å†éœ€è¦è¿”å› `<state_update_json>`
3. **æ›´æ¸…æ™°çš„æŒ‡ä»¤**ï¼šåªè¦æ±‚è¿”å›å™äº‹å†…å®¹

---

## äº‹ä»¶åº“ä¸RAG

### äº‹ä»¶å†™å…¥æ—¶æœº

**å®šæœŸå†™å…¥äº‹ä»¶æ‘˜è¦**ï¼š

ç”±äº AI ä¸å†è¿”å›çŠ¶æ€æ›´æ–°ï¼Œäº‹ä»¶å†™å…¥ç­–ç•¥è°ƒæ•´ä¸ºï¼š

```python
async def handle_persona_maintenance(instance_id, session_id, recent_messages):
    """
    åœ¨ Core Memory ç»´æŠ¤æ—¶åŒæ­¥å†™å…¥äº‹ä»¶æ‘˜è¦
    è§¦å‘æ—¶æœºï¼šæ¯ 30 è½®ï¼ˆä¸ Recall Memory æ¸…ç†åŒæ­¥ï¼‰
    """
    # 1. ç”Ÿæˆæœ€è¿‘å¯¹è¯çš„æ‘˜è¦
    summary = await llm_generate_summary(recent_messages)

    # 2. åˆ›å»ºäº‹ä»¶è®°å½•
    event = {
        "event_id": f"evt_{instance_id}_{session_id}_{turn}",
        "instance_id": instance_id,
        "session_id": session_id,
        "turn": turn,
        "summary": summary,
        "timestamp": now()
    }

    # 3. å¼‚æ­¥å†™å…¥ï¼Œä¸é˜»å¡è¿”å›
    asyncio.create_task(write_event_to_chroma(event))
```

**ç‰¹ç‚¹**ï¼š
- ä¸äººæ ¼ç»´æŠ¤åŒæ­¥ï¼Œå‡å°‘ LLM è°ƒç”¨æ¬¡æ•°
- æ¯ 30 è½®ç”Ÿæˆä¸€æ¬¡æ‘˜è¦ï¼Œè®°å½•é‡è¦äº‹ä»¶
- å¼‚æ­¥å†™å…¥ï¼Œä¸å½±å“å¯¹è¯æµç¨‹

### RAGæ£€ç´¢ç­–ç•¥

**å…³é”®**ï¼šå¿…é¡»è¿‡æ»¤ `instance_id`ï¼Œé¿å…ä¸åŒä¼šè¯å®ä¾‹çš„äº‹ä»¶æ··æ·†

```python
async def rag_query_with_timeout(user_input, instance_id, timeout=1.5):
    """
    RAGæ£€ç´¢ï¼Œå¸¦è¶…æ—¶ä¿æŠ¤
    """
    try:
        events = await asyncio.wait_for(
            chroma.query(
                query_text=user_input,
                filter={"instance_id": instance_id},  # â† å¿…é¡»è¿‡æ»¤
                n_results=5
            ),
            timeout=timeout
        )
        return events
    except asyncio.TimeoutError:
        # è¶…æ—¶åˆ™ä¸ä½¿ç”¨RAGï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½
        return []
```

**ä¸ä½¿ç”¨é“¾è¡¨**ï¼š
- ä¸éœ€è¦ `previous_event` å­—æ®µ
- ä¿¡ä»»Chromaçš„è¯­ä¹‰æ£€ç´¢èƒ½åŠ›
- ç®€åŒ–è®¾è®¡ï¼Œæå‡æ€§èƒ½

---

## æ€§èƒ½ä¼˜åŒ–

### æ€§èƒ½ç“¶é¢ˆä¸è§£å†³æ–¹æ¡ˆ

| ç“¶é¢ˆ | åŸå›  | è§£å†³æ–¹æ¡ˆ | æ•ˆæœ |
|------|------|----------|------|
| RAGæ£€ç´¢æ…¢ | äº‹ä»¶åº“è§„æ¨¡å¤§ | 1. è¿‡æ»¤instance_id<br>2. è¶…æ—¶ä¿æŠ¤(1.5s)<br>3. é™åˆ¶äº‹ä»¶åº“è§„æ¨¡(æ¯å®ä¾‹<1000) | ~500-1500ms |
| äº‹ä»¶å†™å…¥é˜»å¡ | Embedding APIè°ƒç”¨ | å¼‚æ­¥å†™å…¥ï¼Œä¸ç­‰å¾…å®Œæˆ | ~0msï¼ˆä¸é˜»å¡ï¼‰ |
| å¤šæ¬¡æ–‡ä»¶è¯»å– | ä¸²è¡ŒåŠ è½½ | å¹¶è¡ŒåŠ è½½ï¼ˆasyncio.gatherï¼‰ + RecallMemoryCache | å–æœ€æ…¢é¡¹ |

### å¼‚æ­¥ä¼˜åŒ–

```python
# å¹¶è¡Œæ‰§è¡Œå¤šä¸ªIOæ“ä½œ
events, state, bg = await asyncio.gather(
    rag_query_with_timeout(user_input, instance_id),
    load_character_state(instance_id),
    load_background(background_id)
)

# ä»å†…å­˜ç¼“å­˜è¯»å–æœ€è¿‘å¯¹è¯ï¼ˆä¸éœ€è¦å¼‚æ­¥ï¼‰
recent_messages = recall_cache.get_for_prompt()  # ~0ms

# å¼‚æ­¥å†™å…¥äº‹ä»¶ï¼Œä¸é˜»å¡è¿”å›
asyncio.create_task(write_event_async(...))
```

---

## æŠ€æœ¯æ ˆ

### åç«¯

**è¯­è¨€ä¸æ¡†æ¶**ï¼š
- Python 3.11+
- FastAPIï¼ˆREST API + WebSocketï¼‰

**LLMç›¸å…³**ï¼š
- LangChainï¼ˆPromptå·¥ç¨‹ + LLMè°ƒç”¨ï¼‰
- OpenAI API / Claude APIï¼ˆå¯é…ç½®ï¼‰

**å‘é‡æ£€ç´¢**ï¼š
- Chromaï¼ˆæœ¬åœ°å‘é‡æ•°æ®åº“ï¼‰
- OpenAI Embeddings API / æœ¬åœ°Embeddingæ¨¡å‹ï¼ˆå¯é…ç½®ï¼‰

**æ•°æ®å­˜å‚¨**ï¼š
- æ–‡ä»¶ç³»ç»Ÿï¼ˆJSON/JSONLï¼‰
- Chromaå†…ç½®æŒä¹…åŒ–

### å‰ç«¯

**æ¡†æ¶**ï¼š
- Next.js 14 (App Router)
- TypeScript

**UIåº“**ï¼š
- Shadcn/ui
- Tailwind CSSï¼ˆæš—è‰²ä¸»é¢˜ï¼‰

**çŠ¶æ€ç®¡ç†**ï¼š
- Zustandï¼ˆå‰ç«¯ä¸´æ—¶çŠ¶æ€ï¼‰
- localStorageæŒä¹…åŒ–

**é€šä¿¡**ï¼š
- Socket.IO Clientï¼ˆWebSocketï¼Œæµå¼å¯¹è¯ï¼‰
- Fetch APIï¼ˆRESTï¼Œæ•…äº‹çº¿/è§’è‰²/èƒŒæ™¯ç®¡ç†ï¼‰

---

## æ ¸å¿ƒè®¾è®¡åŸåˆ™æ€»ç»“

### âœ… é‡‡ç”¨çš„è®¾è®¡

1. **ä¼šè¯å®ä¾‹æ¶æ„** - çŠ¶æ€éš”ç¦»ï¼Œè§£å†³å¤šä¼šè¯çŠ¶æ€æ±¡æŸ“é—®é¢˜
2. **Core Memory åŠ¨æ€ç®¡ç†** - base_persona + evolved_personaï¼Œè‡ªç„¶è¯­è¨€æè¿°
3. **äº‹ä»¶åº“è¿‡æ»¤** - å¿…é¡»è®°å½•instance_idå’Œsession_id
4. **å®šæœŸç»´æŠ¤ä»»åŠ¡** - æ¯30è½®æ¸…ç†Recall Memory + æ›´æ–°evolved_persona
5. **æ€§èƒ½ä¼˜åŒ–** - å¼‚æ­¥å¹¶è¡Œã€è¶…æ—¶ä¿æŠ¤ã€RecallMemoryCacheã€~2ç§’éLLMè€—æ—¶

### âŒ åˆ é™¤çš„è®¾è®¡

1. **é‡åŒ–æ•°å€¼** - ä¸ä½¿ç”¨priorityã€intensityã€levelç­‰æ•°å­—
2. **æ•°å­—é™çº§** - ä¸ä½¿ç”¨"æ¯Nè½®-1"çš„æœºåˆ¶
3. **äº‹ä»¶é“¾è¡¨** - ä¸ä½¿ç”¨previous_eventï¼Œçº¯RAG
4. **å½’æ¡£æœºåˆ¶** - ä¸ä½¿ç”¨archivedæ ‡è®°ï¼Œç®€åŒ–è®¾è®¡
5. **ä¼šè¯æ‘˜è¦** - ä¸éœ€è¦session_summaryï¼Œä¿¡ä»»RAG

---

## æœ¯è¯­å˜æ›´è¯´æ˜ï¼ˆv0.2.1ï¼‰

**é‡è¦**ï¼šæœ¬æ–‡æ¡£ä¸­å¤§é‡ä½¿ç”¨äº†æ—§æœ¯è¯­"æ•…äº‹çº¿ï¼ˆStorylineï¼‰"ï¼Œåœ¨ v0.2.1 ç‰ˆæœ¬åç»Ÿä¸€æ›´æ–°ä¸º"ä¼šè¯å®ä¾‹ï¼ˆConversation Instanceï¼‰"ã€‚

### æœ¯è¯­å¯¹ç…§è¡¨

| æ—§æœ¯è¯­ | æ–°æœ¯è¯­ | è¯´æ˜ |
|--------|--------|------|
| æ•…äº‹çº¿ï¼ˆStorylineï¼‰ | ä¼šè¯å®ä¾‹ï¼ˆConversation Instanceï¼‰ | æ›´å‡†ç¡®è¡¨è¾¾å…¶æœ¬è´¨ï¼šçŠ¶æ€éš”ç¦»å®¹å™¨ |
| `storyline_id` | `instance_id` | æ•°æ®åº“å­—æ®µå |
| `storylines/` ç›®å½• | `instances/` ç›®å½• | æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ |

**åŸå› **ï¼š
- "æ•…äº‹çº¿"å®¹æ˜“ä¸"å‰§æƒ…ä¸»çº¿"æ··æ·†
- "ä¼šè¯å®ä¾‹"æ›´å‡†ç¡®æè¿°å…¶ä½œç”¨ï¼šåŒä¸€è§’è‰²+èƒŒæ™¯å¯åˆ›å»ºå¤šä¸ªç‹¬ç«‹å®ä¾‹

**æ–‡æ¡£æ›´æ–°è®¡åˆ’**ï¼š
- æœ¬æ–‡æ¡£ï¼ˆDESIGN.mdï¼‰å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å…¨æ–‡æ›´æ–°æœ¯è¯­
- å½“å‰ç‰ˆæœ¬ï¼ˆv0.2.1ï¼‰åœ¨æœ¬ç« èŠ‚è¯´æ˜å³å¯ï¼Œé¿å…å¤§è§„æ¨¡ä¿®æ”¹å¯¼è‡´æ··ä¹±

---

## éœ€æ±‚æ¾„æ¸…åçš„æ–°è®¾è®¡ï¼ˆv0.2.1ï¼‰

### 1. æ•…äº‹ä¸»çº¿å¤§çº²çš„çµæ´»æ€§

**æ•°æ®ç»“æ„è°ƒæ•´**ï¼š
```json
{
  "story_outline": [
    {"index": 1, "content": "å‘ç°èƒŒå›è€…çš„çº¿ç´¢", "status": "completed"},
    {"index": 2, "content": "æ½œå…¥æ•Œäººæ®ç‚¹", "status": "in_progress"},
    // æ•°é‡ä¸å›ºå®šï¼Œç”±ç”¨æˆ·åˆ›å»ºèƒŒæ™¯æ—¶ç¼–å†™ï¼ˆ5-20ä¸ªï¼‰
  ],
  "current_plot_index": 2,
  "outline_completed": false  // æ˜¯å¦å·²å®Œæˆå…¨éƒ¨å¤§çº²ç‚¹
}
```

**è®¾è®¡è¦ç‚¹**ï¼š
- å¤§çº²ç‚¹æ•°é‡**ä¸å›ºå®š**ï¼Œç”±ç”¨æˆ·è‡ªç”±ç¼–å†™
- å¤§çº²æ˜¯**å»ºè®®è·¯çº¿**ï¼Œä¸æ˜¯å¼ºåˆ¶è·¯çº¿
- å®Œæˆåè¿›å…¥**è‡ªç”±å¯¹è¯æ¨¡å¼**ï¼ˆå¯¼æ¼”æ¨¡å—ä¸å†ä»‹å…¥ï¼‰

---

### 2. Core Memory æ‰‹åŠ¨è§¦å‘åŠŸèƒ½

**åŠŸèƒ½éœ€æ±‚**ï¼š
- UI ä½ç½®ï¼šå¯¹è¯ç•Œé¢å·¦ä¾§/å³ä¾§åŠŸèƒ½åŒºï¼ˆå‚ç›´æ’åˆ—ï¼‰
- æŒ‰é’®åç§°ï¼š"ğŸ§  æ›´æ–°è®°å¿†"
- æ‰§è¡Œæ–¹å¼ï¼šåŒæ­¥æ‰§è¡Œï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆçº¦ 6-11 ç§’ï¼‰

**API è®¾è®¡**ï¼š
```python
@router.post("/maintenance/core-memory")
async def trigger_core_memory_maintenance(instance_id: str):
    """
    æ‰‹åŠ¨è§¦å‘ Core Memory ç»´æŠ¤
    """
    # 1. åŠ è½½å½“å‰ Core Memory
    state = load_character_state(instance_id)

    # 2. åŠ è½½æœ€è¿‘ 10 è½®å¯¹è¯
    recent_turns = load_recent_messages(instance_id, n=10)

    # 3. è°ƒç”¨ LLM é‡æ–°ç”Ÿæˆ Core Memory
    new_core_memory = await llm_regenerate_core_memory(
        old_state=state,
        recent_turns=recent_turns
    )

    # 4. å†™å…¥æ–°çš„ Core Memory
    save_character_state(instance_id, new_core_memory)

    # 5. å¯é€‰ï¼šå¼‚æ­¥å†™å…¥äº‹ä»¶åº“
    asyncio.create_task(write_maintenance_event(...))

    return {"success": True, "message": "Core Memory å·²æ›´æ–°"}
```

**åå°ç®¡ç†ç«¯åŠŸèƒ½**ï¼š
- æŸ¥çœ‹ Core Memory ç»´æŠ¤å†å²
- æŸ¥çœ‹æ¯æ¬¡ç»´æŠ¤çš„è¾“å…¥å’Œè¾“å‡º
- å›æ»šåˆ°å†å²ç‰ˆæœ¬

---

### 3. å¯¼æ¼”æ¨¡å—çš„"æ‹‰å›ä¸»çº¿"åŠŸèƒ½

**åŠŸèƒ½éœ€æ±‚**ï¼š
- UI ä½ç½®ï¼šå¯¹è¯ç•Œé¢å·¦ä¾§/å³ä¾§åŠŸèƒ½åŒºï¼ˆå‚ç›´æ’åˆ—ï¼‰
- æŒ‰é’®åç§°ï¼š"ğŸ¬ æ‹‰å›ä¸»çº¿"
- å®ç°æœºåˆ¶ï¼šé€šè¿‡**æŸç§ç­–ç•¥**å°†ä¿¡æ¯**æ’å…¥åˆ°ç‰¹å®šä½ç½®**ï¼Œå½±å“ Prompt ç»„è£…

**è®¾è®¡æ€è·¯**ï¼ˆå¾…ç»†åŒ–ï¼‰ï¼š
- ç”¨æˆ·ç‚¹å‡»æŒ‰é’®åï¼Œåç«¯è§¦å‘ç‰¹æ®Šçš„ Prompt æ³¨å…¥
- å…·ä½“ç­–ç•¥å’Œæ³¨å…¥ä½ç½®å¾…åç»­è®¨è®º
- ç›®æ ‡ï¼šè‡ªç„¶åœ°å°†åç¦»çš„å‰§æƒ…å¼•å¯¼å›ä¸»çº¿

---

### 4. äº‹ä»¶å†™å…¥å¤±è´¥çš„æš‚å­˜æœºåˆ¶

**æ–°å¢ç›®å½•ç»“æ„**ï¼š
```
data/
â”œâ”€â”€ instances/
â”‚   â””â”€â”€ {instance_id}/
â”‚       â”œâ”€â”€ pending_events/          â† æ–°å¢ï¼šå¾…å†™å…¥äº‹ä»¶æš‚å­˜
â”‚       â”‚   â”œâ”€â”€ pending_001.json
â”‚       â”‚   â”œâ”€â”€ pending_002.json
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ metadata.json
â”‚       â”œâ”€â”€ character_state.json
â”‚       â””â”€â”€ sessions/
```

**å†™å…¥æµç¨‹**ï¼š
```python
async def write_event_to_chroma(event_data, instance_id):
    # 1. å…ˆå†™å…¥æš‚å­˜æ–‡ä»¶
    timestamp = now().isoformat()
    pending_file = f"data/instances/{instance_id}/pending_events/pending_{timestamp}.json"
    await write_json(pending_file, event_data)

    try:
        # 2. å°è¯•å†™å…¥ Chroma
        await chroma_collection.add(
            embeddings=embed(event_data['content']),
            documents=[event_data['content']],
            metadatas=[event_data['metadata']]
        )

        # 3. å†™å…¥æˆåŠŸï¼Œåˆ é™¤æš‚å­˜æ–‡ä»¶
        await delete_file(pending_file)

    except Exception as e:
        # 4. å†™å…¥å¤±è´¥ï¼Œä¿ç•™æš‚å­˜æ–‡ä»¶
        logger.error(f"Failed to write event to Chroma: {e}")

        # 5. é€šçŸ¥ç”¨æˆ·ï¼ˆé€šè¿‡ WebSocketï¼‰
        await ws.send_json({
            "type": "event_write_failed",
            "message": "äº‹ä»¶è®°å½•å¤±è´¥ï¼Œå·²æš‚å­˜å¾…å¤„ç†",
            "pending_file": pending_file
        })
```

**åå°ç®¡ç†ç«¯ API**ï¼š
```python
# è·å–æ‰€æœ‰å¾…å¤„ç†äº‹ä»¶
@router.get("/admin/pending-events")
async def get_pending_events():
    ...

# é‡è¯•å†™å…¥æŸä¸ªäº‹ä»¶
@router.post("/admin/pending-events/{file_id}/retry")
async def retry_pending_event(file_id: str):
    ...

# æ‰¹é‡é‡è¯•æŸä¸ªå®ä¾‹çš„æ‰€æœ‰äº‹ä»¶
@router.post("/admin/pending-events/retry-all")
async def retry_all_pending_events(instance_id: str):
    ...

# åˆ é™¤æŸä¸ªå¾…å¤„ç†äº‹ä»¶
@router.delete("/admin/pending-events/{file_id}")
async def delete_pending_event(file_id: str):
    ...
```

---

### 5. UI å¸ƒå±€è®¾è®¡

**ä¸‰æ å¸ƒå±€**ï¼ˆç±»ä¼¼ SillyTavernï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          â”‚ [é¡¶éƒ¨åŠŸèƒ½æ ]             â”‚          â”‚
â”‚          â”‚ - åˆ‡æ¢ä¼šè¯å®ä¾‹           â”‚          â”‚
â”‚          â”‚ - å…¨å±€è®¾ç½®               â”‚          â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚          â”‚                         â”‚          â”‚
â”‚ å·¦ä¾§è¾¹æ  â”‚                         â”‚ å³ä¾§è¾¹æ  â”‚
â”‚ (é¡¶åˆ°åº•) â”‚    å¯¹è¯æ¶ˆæ¯åŒº           â”‚ (é¡¶åˆ°åº•) â”‚
â”‚          â”‚    - AI å›å¤            â”‚          â”‚
â”‚ ğŸ§ æ›´æ–°è®°å¿†â”‚    - ç”¨æˆ·æ¶ˆæ¯           â”‚ ğŸ“Šè§’è‰²çŠ¶æ€â”‚
â”‚          â”‚    - æµå¼æ˜¾ç¤º           â”‚          â”‚
â”‚ ğŸ¬æ‹‰å›ä¸»çº¿â”‚                         â”‚ ğŸ“šå†å²äº‹ä»¶â”‚
â”‚          â”‚                         â”‚          â”‚
â”‚ âš™ï¸ è®¾ç½®   â”‚                         â”‚ ğŸ“–ä¸–ç•Œä¹¦  â”‚
â”‚          â”‚                         â”‚          â”‚
â”‚ ...     â”‚                         â”‚ ...     â”‚
â”‚          â”‚                         â”‚          â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚          â”‚ [ç”¨æˆ·è¾“å…¥æ¡†]   [å‘é€]    â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**ï¼š
- **ä¸‰ä¸ªåŒºåŸŸï¼ˆå·¦ã€ä¸­ã€å³ï¼‰éƒ½æ˜¯ä»é¡¶åˆ°åº•**
- ä¸­é—´åŒºåŸŸå†…éƒ¨åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š
  - ä¸Šï¼šé¡¶éƒ¨åŠŸèƒ½æ ï¼ˆé«˜åº¦å°ï¼‰
  - ä¸­ï¼šå¯¹è¯æ¶ˆæ¯åŒºï¼ˆé«˜åº¦å¤§ï¼Œå¯æ»šåŠ¨ï¼‰
  - ä¸‹ï¼šç”¨æˆ·è¾“å…¥æ¡†ï¼ˆé«˜åº¦å°ï¼Œä¸é¡¶éƒ¨åŠŸèƒ½æ é¢ç§¯ç›¸åŒï¼‰
- ä¸­é—´åŒºåŸŸå æ¯”çº¦ 50%
- å·¦å³ä¾§è¾¹æ å¯ä¼¸ç¼©ï¼ŒåŠŸèƒ½æŒ‰é’®å‚ç›´æ’åˆ—

---

### 6. `[PROGRESS]` æ ‡è®°æœºåˆ¶çš„ Prompt è®¾è®¡

**System Prompt ç¤ºä¾‹**ï¼ˆæ”¾å…¥å¤´éƒ¨ 4Kï¼‰ï¼š
```
ã€å‰§æƒ…è¿›åº¦æŠ¥å‘Šè§„åˆ™ã€‘
ä½ å¿…é¡»åœ¨æ¯æ¬¡å›å¤çš„æœ«å°¾æ·»åŠ å‰§æƒ…è¿›åº¦æ ‡è®°ï¼Œæ ¼å¼ä¸ºï¼š[PROGRESS:X:status]

å‚æ•°è¯´æ˜ï¼š
- X: å½“å‰å¤§çº²ç‚¹çš„ç´¢å¼•ï¼ˆ1-Nï¼‰
- status: è¿›åº¦çŠ¶æ€
  - in_progress: æ­£åœ¨è¿›è¡Œæ­¤å¤§çº²ç‚¹
  - completed: å·²å®Œæˆæ­¤å¤§çº²ç‚¹

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼š"æˆ‘èµ°è¿›äº†æ®ç‚¹"
AIå›å¤ï¼š"ä½ æ¨å¼€ç”Ÿé”ˆçš„é“é—¨ï¼Œæ®ç‚¹å†…ä¸€ç‰‡ç‹¼è—‰..." [PROGRESS:2:in_progress]

å½“å‰å‰§æƒ…çŠ¶æ€ï¼š
{
  "story_outline": [
    {"index": 1, "content": "å‘ç°èƒŒå›è€…çš„çº¿ç´¢", "status": "completed"},
    {"index": 2, "content": "æ½œå…¥æ•Œäººæ®ç‚¹", "status": "in_progress"}, â† å½“å‰è¿™é‡Œ
    {"index": 3, "content": "ä¸ä»‡äººå¯¹å³™", "status": "pending"},
    ...
  ]
}

é‡è¦ï¼šå¦‚æœä½ è®¤ä¸ºå¤§çº²ç‚¹å·²ç»å®Œæˆï¼Œç«‹å³æ ‡è®°ä¸º completedï¼
```

**Few-shot Examples**ï¼ˆæ”¾å…¥ Promptï¼‰ï¼š
```
ç¤ºä¾‹ 1ï¼š
User: æˆ‘åœ¨æ®ç‚¹å¤–è§‚å¯Ÿ
Assistant: ä½ èº²åœ¨åºŸå¢Ÿåï¼Œé€è¿‡ç ´ç¢çš„çª—æˆ·çœ‹åˆ°é‡Œé¢æœ‰3ä¸ªäººå½±åœ¨ç§»åŠ¨... [PROGRESS:2:in_progress]

ç¤ºä¾‹ 2ï¼š
User: æˆ‘ç¿»å¢™è¿›å…¥æ®ç‚¹
Assistant: ä½ æˆåŠŸç¿»è¿‡å›´å¢™ï¼Œæ‚„æ‚„æ½œå…¥æ®ç‚¹å†…éƒ¨ã€‚å‰æ–¹èµ°å»Šä¼ æ¥è„šæ­¥å£°... [PROGRESS:2:completed]

ç¤ºä¾‹ 3ï¼š
User: æˆ‘èµ°å‘ä»‡äººæ‰€åœ¨çš„æˆ¿é—´
Assistant: ä½ æ¨å¼€æˆ¿é—¨ï¼Œçœ‹åˆ°é‚£ä¸ªèƒŒå›ä½ çš„äººæ­£ååœ¨æ²™å‘ä¸Šï¼Œå†·ç¬‘ç€çœ‹å‘ä½ ... [PROGRESS:3:in_progress]
```

**åç«¯æ­£åˆ™æ‰«æ**ï¼š
```python
import re

def extract_progress_tag(ai_response: str) -> tuple[str, dict]:
    """
    ä» AI å›å¤ä¸­æå– [PROGRESS] æ ‡è®°
    è¿”å›ï¼š(æ¸…ç†åçš„å›å¤, è¿›åº¦ä¿¡æ¯)
    """
    pattern = r'\[PROGRESS:(\d+):(in_progress|completed|pending)\]'
    match = re.search(pattern, ai_response)

    if match:
        index = int(match.group(1))
        status = match.group(2)

        # ä»å›å¤ä¸­åˆ é™¤æ ‡è®°
        cleaned_response = re.sub(pattern, '', ai_response).strip()

        return cleaned_response, {"index": index, "status": status}
    else:
        return ai_response, None
```

---

**æ–‡æ¡£ç»“æŸ**
