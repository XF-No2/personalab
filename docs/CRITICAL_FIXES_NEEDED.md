# DESIGN.md 关键修复清单

**创建时间**: 2025-10-14
**优先级**: 🚨 紧急 - 阻塞开发

---

## 问题总结

DESIGN.md 文档存在**严重的数据结构双重标准**问题，导致系统设计不一致，**无法开始开发**。

---

## 必须立即修复的问题

### 1. 统一数据结构（🚨 最高优先级）

**现状**：文档中同时存在两套人格数据结构

**行动**：
- [ ] 删除第158-329行中所有 `core_identity`/`growth_state`/`current_state` 的示例
- [ ] 统一使用 `base_persona` + `evolved_persona` 结构
- [ ] 重写"角色定义"的 `initial_profile` 字段
- [ ] 重写"角色状态"的完整数据结构

**影响文件**：
- `data/characters/{character_id}/definition.json`
- `data/instances/{instance_id}/character_state.json`

---

### 2. 删除"人格三层机制"的所有引用

**位置**：
- 第77行：人格成长逻辑闭环
- 第258行：角色状态结构示例注释
- 第888行：核心设计原则总结
- 第949-978行：需求澄清中的"快动态层维护策略"

**行动**：
- [ ] 第77行：改为"角色当前状态（base_persona + evolved_persona）"
- [ ] 第258行：删除"详见人格三层机制"的注释
- [ ] 第888行：改为"Core Memory 动态管理机制"
- [ ] 第949-978行：整节删除（与新设计冲突）

---

### 3. 全文替换术语

**行动**：
- [ ] 全文搜索 `storyline_id` → 替换为 `instance_id`
- [ ] 全文搜索 `storylines/` → 替换为 `instances/`
- [ ] 更新文件组织结构（第104-156行）
- [ ] 更新事件数据结构（第360-390行）

---

### 4. 重写关键章节

#### 4.1 第4节"数据结构设计"

需要完全重写以下部分：
- [ ] 角色定义（第160-194行）
- [ ] 角色状态（第252-329行）
- [ ] 事件结构（第360-390行）

#### 4.2 人格成长逻辑闭环

需要重新设计：
- [ ] 如何在只有 `base_persona` + `evolved_persona` 的情况下实现成长？
- [ ] 快速变化的情绪/状态如何处理？（原本在 current_state 中）
- [ ] 是否需要在 `evolved_persona` 中包含"当前状态"？

---

## 设计决策需要澄清

### 问题1：快速变化的状态去哪了？

**旧设计**：
```json
{
  "current_state": {
    "emotions": ["愤怒", "绝望"],
    "physical": "左臂受伤",
    "immediate_goals": ["找到安全屋"]
  }
}
```

**新设计**：
```json
{
  "evolved_persona": "经历了背叛，变得谨慎..."
}
```

**问题**：
- 新设计中，"左臂受伤"这种临时状态放哪里？
- "当前情绪"如何表达？
- 还是说完全依赖"最近对话历史"？

**可能的解决方案**：
1. **方案A**：evolved_persona 只记录长期成长，短期状态完全依赖 Recall Memory
2. **方案B**：evolved_persona 包含"当前状态快照"
3. **方案C**：恢复三层结构（但这与简化设计的初衷矛盾）

---

### 问题2：v0.2.1 的"快动态层维护策略"怎么办？

第949-978行描述了详细的 `current_state` 维护策略，但这与新设计冲突。

**决策**：
- [ ] 选项A：删除这一节（因为不再有 current_state）
- [ ] 选项B：修改为"evolved_persona 的短期状态管理"
- [ ] 选项C：保留 current_state，但作为 evolved_persona 的子字段

---

## 修复顺序建议

### 第1步：确定最终数据结构
- [ ] 明确 `character_state.json` 的完整结构
- [ ] 确定是否需要"当前状态"字段
- [ ] 绘制完整的数据模型图

### 第2步：重写第4节"数据结构设计"
- [ ] 角色定义
- [ ] 角色状态
- [ ] 会话消息
- [ ] 事件结构

### 第3步：全文替换术语
- [ ] storyline → instance
- [ ] 三层人格 → Core Memory 动态管理

### 第4步：验证一致性
- [ ] 检查所有代码示例使用相同的数据结构
- [ ] 检查 Prompt 组装逻辑与数据结构匹配
- [ ] 检查维护任务与数据结构匹配

---

## 验证清单

修复完成后，必须通过以下检查：

- [ ] 全文搜索 `core_identity` → 应该只出现在"旧设计对比"或"术语变更说明"中
- [ ] 全文搜索 `growth_state` → 同上
- [ ] 全文搜索 `current_state` → 同上（或明确其新的定义）
- [ ] 全文搜索 `三层人格` → 应该为 0 结果
- [ ] 全文搜索 `storyline_id` → 应该为 0 结果（除术语变更说明）
- [ ] 所有代码示例使用相同的字段名
- [ ] Prompt 组装、维护任务、数据加载逻辑完全一致

---

**下一步**：在修复这些问题之前，**不建议开始开发**。
