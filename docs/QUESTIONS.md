# 待解决问题清单

**创建日期**: 2025-10-13
**最后更新**: 2025-10-13

---

## 高优先级问题

### 1. 会话文件的metadata字段

**问题**：会话文件第一行（metadata）具体包含哪些字段？

**目前假设**：
```json
{
  "type": "metadata",
  "character_id": "alserqi_v1",
  "background_id": "wasteland_world",
  "title": "与Alserqi的第一次对话",
  "created_at": "2025-10-13T10:00:00Z"
}
```

**待确认**：
- `title` 字段是否需要？用户能否自定义会话标题？
- 是否需要 `last_updated` 字段？
- 是否需要其他字段（如 `tags`, `status` 等）？

---

### 2. 角色状态文件的初始化时机

**问题**：`dynamic_profile.json` 何时创建？

**方案A：创建角色时立即生成**
```
用户创建角色
  ↓
生成 definition.json
  ↓
生成 dynamic_profile.json（复制initial_profile）
```

**方案B：第一次使用时生成**
```
用户创建角色
  ↓
只生成 definition.json
  ↓
（后续）用户创建会话，选择此角色
  ↓
检查 dynamic_profile.json 是否存在
  ↓
不存在 → 复制 initial_profile 生成
```

**待确认**：采用哪种方案？

---

### 3. 多个会话共享状态的并发问题

**问题场景**：
```
用户打开会话A（角色：Alserqi）
  ↓
对话，更新了 dynamic_profile.json（关系变为"盟友"）
  ↓
用户切换到会话B（同样使用角色：Alserqi）
  ↓
此时会话B读取的状态已经变了
```

**这是预期行为吗？**

**可能方案**：
- **方案A（接受）**：状态是全局的，所有会话共享，这是人格连续成长的体现
- **方案B（隔离）**：每个会话创建时，复制一份独立的状态副本
- **方案C（提示）**：前端检测状态变化，提示用户"角色状态已更新"

**待确认**：采用哪种方案？

---

### 4. 事件归档是否记录来源会话

**问题**：event_log中的事件，是否需要 `source_session_id` 字段？

**不记录的理由**：
- 事件完全抽象化，不关心具体角色和会话
- RAG检索只看语义相似度
- 简化设计

**记录的理由**：
- 调试时可追溯事件来源
- 可能需要"删除某个会话的所有事件"
- 可能需要"查看某个会话产生了哪些事件"

**待确认**：是否记录？如果记录，是否影响"事件完全脱离角色"的设计？

---

## 中优先级问题

### 5. Prompt模板管理功能的范围

**问题**：V1.0是否需要实现前端的Prompt模板管理页面？

**完整功能**：
- `/prompt-templates` 管理页面
- 增删改查模块
- 拖拽排序
- 开关模块
- 实时预览

**简化方案（V1.0）**：
- 使用固定的默认模板
- 不提供前端管理页面
- 后期V2.0再实现

**待确认**：V1.0包含哪些功能？

---

### 6. 定时维护任务的触发机制

**问题**：dynamic_profile的去重/降级/清理任务，如何触发？

**方案A：对话计数触发**
```python
if conversation_count % 10 == 0:
    run_maintenance_task(profile)
```

**方案B：定时任务**
```python
# 每天凌晨3点执行
schedule.every().day.at("03:00").do(run_maintenance_task)
```

**方案C：手动触发**
```
前端提供"维护角色状态"按钮
用户点击后执行
```

**待确认**：采用哪种方案？是否需要多种方式结合？

---

### 7. 事件库规模控制

**问题**：随着时间推移，event_library会不断膨胀，是否需要限制？

**方案A：不限制**
- 依赖Chroma的性能
- 向量数据库理论上可以处理大规模数据

**方案B：设置上限**
- 例如：最多1万条事件
- 超过后，删除最旧的事件

**方案C：提供清理功能**
- 前端提供"清理事件库"按钮
- 用户可以手动清理低优先级/旧事件

**待确认**：采用哪种方案？

---

## 低优先级问题

### 8. 会话导出格式

**问题**：会话导出为Markdown时，格式如何设计？

**可能格式**：
```markdown
# 与Alserqi的第一次对话

**角色**: Alserqi
**背景**: 废土世界
**创建时间**: 2025-10-13 10:00:00

---

## 对话记录

**用户**：你这个骗子！

**Alserqi**：Alserqi听了你的话，眼中闪过一丝轻蔑...

**用户**：我有证据

**Alserqi**：他看到文件，瞳孔微缩...
```

**待确认**：
- 是否需要包含metadata？
- 是否需要包含时间戳？
- 是否需要标记"已归档"的消息？

---

### 9. 角色头像与资源管理

**问题**：角色的头像图片如何存储和管理？

**可能方案**：
```
data/characters/{character_id}/
├── definition.json
├── dynamic_profile.json
└── avatar.png              # 头像图片
```

**待确认**：
- 前端上传头像时，后端如何处理？
- 是否支持多种格式（png/jpg/webp）？
- 是否需要缩略图？

---

### 10. 背景的initial_context使用方式

**问题**：背景中的 `initial_context` 字段如何使用？

**可能用途**：
- 创建新会话时，作为第一条系统消息？
- 还是只是用户参考，不自动使用？

**待确认**：具体使用方式？

---

### 11. 前端的角色/背景列表排序

**问题**：角色管理页、背景管理页，列表如何排序？

**可能方案**：
- 按创建时间（最新在前）
- 按最后使用时间（最近使用在前）
- 按字母顺序
- 用户自定义排序

**待确认**：默认排序方式？

---

## 技术细节问题

### 12. LLM输出格式保证

**问题**：如何确保LLM可靠地生成正确的XML格式输出？

**目前方案**：
- 使用强Prompt指令
- 验证失败则回滚

**可能优化**：
- 使用LangChain的Structured Output
- 使用Function Calling（OpenAI/Claude）
- 使用JSON Schema约束（Gemini）

**待确认**：V1.0使用哪种方案？

---

### 13. RAG检索策略

**问题**：RAG检索时，是否需要过滤策略？

**目前方案**：
- 纯语义检索，不过滤
- 返回Top-3

**可能优化**：
- 按时间加权（最近的事件权重更高）
- 按优先级过滤（只检索高优先级事件）
- 多样性控制（避免返回重复类型的事件）

**待确认**：V1.0使用哪种策略？

---

### 14. WebSocket断线重连

**问题**：用户对话过程中，WebSocket断开如何处理？

**可能方案**：
- 前端自动重连
- 断线期间的消息如何处理？
- 是否需要消息队列？

**待确认**：断线重连的具体逻辑？

---

### 15. Chroma数据库的持久化策略

**问题**：Chroma的数据是否需要定期备份？

**可能方案**：
- 不备份，依赖Chroma自身的持久化
- 定期导出（如每天）
- Git不跟踪Chroma数据（.gitignore）

**待确认**：采用哪种策略？

---

## 产品设计问题

### 16. 用户是否可以删除角色

**问题**：如果用户删除角色，相关数据如何处理？

**涉及数据**：
- `characters/{id}/` 整个目录
- 使用该角色的会话文件
- event_library中相关事件（如果记录了来源）

**可能方案**：
- **软删除**：标记为删除，但保留数据
- **硬删除**：彻底删除，但保留会话文件（标记角色已删除）
- **禁止删除**：如果角色有会话，不允许删除

**待确认**：采用哪种方案？

---

### 17. 用户是否可以"重置"角色状态

**问题**：如果用户想"重新开始"一个角色，是否支持重置状态？

**可能功能**：
- 重置 `dynamic_profile.json` 到初始状态
- 保留历史会话文件
- 或者：创建新角色（复制定义）

**待确认**：是否需要此功能？

---

### 18. 前端是否展示角色的当前状态

**问题**：前端是否需要实时显示角色的情绪、关系等状态？

**可能位置**：
- 对话界面右侧：状态面板
- 角色管理页：状态预览

**待确认**：V1.0是否包含？如何展示？

---

## 其他问题

### 19. 项目名称与域名

**问题**：项目对外名称是否确定为 "PersonaLab"？

**相关**：
- README.md中的名称
- 前端页面标题
- 未来的域名

**待确认**：最终名称？

---

### 20. 开源计划

**问题**：项目是否计划开源？

**如果开源，需要考虑**：
- LICENSE文件
- 敏感信息处理（API密钥等）
- 文档完善度

**待确认**：开源计划？

---

**文档结束**
