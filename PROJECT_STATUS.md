# PersonaLab 项目当前状态

**最后更新**: 2025-10-16
**当前版本**: v0.3.3 (删除无用设计，简化架构)
**状态**: 🟡 设计阶段

> 📌 **重要**：这是项目的"活文档"，记录**当前真实状态**，而非某个发布版本。
> 版本发布时，会归档快照到 `docs/archive/v{版本号}/`

---

## 🎯 项目概述

PersonaLab（人格实验室）是一个 **AI 角色对话平台**，支持长篇、高一致性、角色可成长的互动叙事。

### 核心功能需求

1. **会话实例管理** - 创建独立的对话实例，状态隔离
2. **导演模块** - 剧情推进控制，确保AI不偏离主线
3. **流式对话** - WebSocket 实时通信，打字机效果
4. **人格成长** - 三层人格机制（静态+慢动态+快动态）
5. **长期记忆** - RAG向量检索历史事件
6. **角色管理** - 自定义角色人格和描述（CRUD）
7. **背景管理** - 创建对话场景背景（CRUD）
8. **暗色主题** - 专业的暗色 UI 设计

### 技术选型（已确定）

**前端**：
- **框架**: Next.js 14 (App Router)
- **语言**: TypeScript
- **UI 库**: Shadcn/ui + Tailwind CSS
- **状态管理**: Zustand（前端临时状态）
- **通信**: Socket.IO Client (WebSocket) + Fetch API (REST)

**后端**：
- **语言**: Python 3.11+
- **框架**: FastAPI（REST API + WebSocket）
- **LLM**: LangChain + OpenAI/Claude API
- **向量库**: Chroma（本地部署）
- **存储**: 文件系统（JSON/JSONL）

---

## 🏗️ 架构状态

### 目录结构（最新设计）

```
personalab/
├── frontend/                 # 前端（待生成）
│   ├── src/
│   │   ├── app/            # Next.js 页面
│   │   │   ├── instances/   # 会话实例管理页面
│   │   │   ├── characters/  # 角色管理页面
│   │   │   └── backgrounds/ # 背景管理页面
│   │   ├── components/     # UI 组件
│   │   ├── lib/            # 工具库
│   │   └── types/          # TypeScript 类型
│   └── package.json
│
├── backend/                  # 后端（待生成）
│   ├── app/
│   │   ├── main.py         # FastAPI 入口
│   │   ├── models/         # Pydantic 数据模型
│   │   ├── core/           # 核心业务逻辑
│   │   │   ├── state_manager.py      # 状态管理
│   │   │   ├── event_manager.py      # 事件库管理
│   │   │   ├── prompt_engine.py      # Prompt组装
│   │   │   └── interaction_loop.py   # 核心交互流程
│   │   ├── api/            # REST API
│   │   └── websocket/      # WebSocket
│   └── requirements.txt
│
├── data/                     # 数据目录（运行时生成）
│   ├── characters/          # 角色库（全局）
│   ├── backgrounds/         # 背景库（全局）
│   ├── instances/           # 会话实例（核心）
│   │   └── {instance_id}/
│   │       ├── metadata.json
│   │       ├── character_state.json
│   │       └── sessions/
│   ├── event_library/       # 全局事件库
│   │   └── chroma_db/
│   └── prompt_templates/
│
├── docs/
│   ├── DESIGN_OVERVIEW.md   # 概要设计文档 ✅ v0.3.3
│   ├── REQUIREMENTS.md      # 需求文档 ✅ v2.2
│   ├── QUESTIONS.md         # 待解决问题清单 ✅
│   ├── archive/
│   └── reports/
│
├── temp/
│   ├── reports/
│   └── tests/
│
├── PROJECT_STATUS.md         # 项目状态（本文件）
├── 规范.md                   # 工作规范
├── README.md
└── CHANGELOG.md
```

---

## 🔧 核心架构设计

### 会话实例架构（Conversation Instance）

**核心概念**：
- 会话实例是状态隔离容器，用于同一角色+背景的多次游玩
- 角色状态属于会话实例，不属于全局
- 不同会话实例完全隔离，互不影响
- 一个会话实例内可以有多个会话（暂停/继续）

**数据流**：
```
角色定义（全局）→ 会话实例1 → 角色状态1 → 会话1, 会话2, 会话3
                  → 会话实例2 → 角色状态2 → 会话4, 会话5
```

### 导演模块（Director）

**核心职责**：控制剧情推进，确保AI不偏离主线大纲

**三层控制机制**：
1. **静态约束**：主线大纲（10个点）全量放入Prompt头部4K，JSON格式
2. **动态引导**：剧情状态管理 - AI输出`[PROGRESS:X:status]`，后端正则扫描更新
3. **RAG兜底**：连续3轮未更新时，分层检索（当前实例15条 + 其他实例5条）

**扩展性**：剧情状态管理是导演模块子功能之一，未来可扩展更多机制

### 人格三层机制

**核心原理**：数据的变化速度不同

1. **静态层（core_identity）** - 永不变化
   - archetype, core_goal, core_traits, background_story

2. **慢动态层（growth_state）** - 重大事件才变化
   - beliefs（信念）
   - behavioral_patterns（行为模式）
   - relationships（关系深度）

3. **快动态层（current_state）** - 频繁变化
   - emotions（当前情绪）
   - physical（身体状况）
   - immediate_goals（短期目标）

**维护机制**：
- 每10轮对话执行定期维护任务
- 清理过多累积（快动态层保留最新5个）
- 去重、合并（慢动态层）
- **纯定性描述，绝对禁止量化数值**

### 事件库与RAG

**设计要点**：
- 事件必须记录 `instance_id` 和 `session_id`
- RAG检索策略：
  - 日常对话：只检索当前实例（20条），严格隔离
  - 导演兜底：跨实例检索（当前实例15条 + 其他实例5条）
- 不使用事件链表（previous_event），纯语义检索
- 只在状态变化时写入事件
- 异步写入，不阻塞返回

---

## 📊 当前状态

### 已完成

- [x] 完成核心技术设计（DESIGN.md v0.2.0）
- [x] 明确会话实例（Conversation Instance）架构
- [x] 设计人格三层机制（纯定性）
- [x] 设计事件库结构（带instance_id过滤）
- [x] 设计性能优化方案（~2秒非LLM耗时）
- [x] 删除所有过度设计（量化、链表、归档、摘要）
- [x] 完成需求文档（REQUIREMENTS.md v2.2）
- [x] 研究Silly Tavern和Letta/MemGPT参考系统
- [x] 设计导演模块（Director）- 剧情推进控制
- [x] 设计分层检索策略（当前实例 + 其他实例经验）

### 进行中

- [x] 需求澄清讨论（2025-10-14 晚）
- [x] UI 布局修正与功能清单整理（2025-10-14 晚）
- [ ] 🔴 梳理系统运作机制总览（2025-10-14 晚）- 进行中
  - [ ] 第一步：完整交互流程（端到端，标注所有机制介入点）
  - [ ] 第二步：关键时机的决策树
  - [ ] 第三步：Prompt组装的完整规则
  - [ ] 第四步：状态变更的传播路径
- [ ] 待讨论：导演模块"拉回主线"具体策略
- [ ] 待讨论：快动态层"升级"机制设计
- [ ] 待实现：后端核心模块
- [ ] 待实现：前端UI

---

## 📝 最近调整记录

### 2025-10-16 - 删除无用设计，简化架构 ✅

**背景**：
在审查 v0.3.2 时发现多个过度设计和无用字段，导致架构复杂化。

**修复内容**：
1. **删除 status 字段**
   - 删除会话文件的 `status` 字段（"active" / "closed" / "summarized"）
   - 原因：汇总后必然开启新会话，旧会话的状态完全没用
   - 判断当前会话：通过 instance/metadata.json 中的 `current_session_id`

2. **重新设计会话编辑功能**
   - 删除"回退 N 轮"功能及其所有约束条件
   - 改为"会话编辑功能"（Prompt 编辑器）
   - **核心理念**：对话界面是 Prompt 编辑器，操作单位是"一条消息"
   - 用户可以：
     - 删除任意消息（user 或 assistant）
     - 编辑任意消息的内容
     - 删除中间部分（如删除 3、4，保留 1、2、5、6）
     - 无任何限制，自由编辑对话历史
   - 之前的约束完全是过度设计：
     - ❌ "只能回退 active 会话"
     - ❌ "不能回退 summarized 会话"
     - ❌ "必须删除最后 N 轮"
     - ❌ "检查会话状态"

3. **修复分层摘要命名**
   - "粗粒度层/细粒度层" → "Summaries Collection / Plots Collection"
   - 原因：如果增加中间层，"粗细粒度"命名无法扩展
   - 新命名按内容命名，可扩展性强

**文档更新**：
- DESIGN_OVERVIEW.md v0.3.2 → v0.3.3
- 删除所有对 status 字段的引用
- 3.4 节从"回退重新生成流程"改为"会话编辑功能（Prompt 编辑器）"
- 统一使用 Summaries/Plots 命名

**设计原则**：
- ✅ 用户完全控制：没有任何编辑限制
- ✅ 简单直接：不需要状态检查、不需要缓存同步
- ✅ 核心理念：对话界面 = Prompt 编辑器

### 2025-10-16 - 修复概要设计文档的逻辑冲突 ✅

**背景**：
审查 DESIGN_OVERVIEW.md v0.3.1 时发现 5 个严重逻辑问题和 3 个次要边界条件缺失。

**修复内容**：
1. **术语统一（问题1）**
   - "父子结构" → "分层摘要（Hierarchical Summary）"
   - 统一使用"粗粒度层"和"细粒度层"描述两个 Chroma Collection
   - 避免层级增加时的命名混乱（不会出现"爷孙结构"）

2. **修复 Chroma 写入冲突（问题2）**
   - 明确：汇总功能写入 Chroma（分层摘要）
   - 明确：更新记忆只修改 character_state.json，不写入 Chroma
   - 删除 3.3 节中"可选写入事件摘要"的描述
   - 避免数据重复写入导致库结构混乱

3. **补充会话文件格式定义（问题3）**
   - 新增 `type:"summary"` 消息类型定义
   - 明确新会话文件包含：metadata + summary + 最后5轮对话
   - 补充首次会话和汇总后新会话的完整示例
   - 明确数据格式的使用者：存储用 JSON，AI 消费用纯文本

4. **明确 RAG 检索范围（问题4）**
   - RAG 只检索**已汇总的会话**（status: "summarized"）
   - 当前活跃会话不走 RAG（直接全量读取 .jsonl 文件）
   - 首次对话时 Chroma 为空（正常情况，返回空列表）

5. **新增回退功能约束（问题5）**
   - 只有 status: "active" 的会话才能回退
   - status: "summarized" 或 "closed" 的会话不可回退（前端禁用按钮）
   - 避免与 Chroma 数据不一致

6. **优化导演模块描述（问题6）**
   - 跨实例检索标注为"可选"
   - 明确语义：借鉴其他剧情线的推进方式
   - 添加注意事项：需标注"剧情经验参考"，避免混淆事实

**文档版本**：
- DESIGN_OVERVIEW.md v0.3.1 → v0.3.2
- 更新变更记录，详细记录所有修复

**逻辑验证**：
- ✅ 数据流完整性（数据从创建到使用的闭环）
- ✅ 功能间依赖关系和调用链
- ✅ 状态管理的一致性
- ✅ 边界条件和异常场景

### 2025-10-15 01:30 - 设计汇总功能的分层摘要 ✅

**核心设计**：
1. **汇总功能分层摘要**
   - 一次 LLM 调用生成两层数据：摘要（粗粒度）+ 详细素材（细粒度）
   - JSON 格式输出：`[{"summary": "摘要", "details": "详细素材"}]`
   - 严格解析：解析失败直接报错，由用户决定重试，不使用降级方案

2. **Chroma 分层存储**
   - Summaries Collection：粗粒度层，存储摘要
   - Plots Collection：细粒度层，存储详细素材
   - 通过 related_summary_id / related_plot_id 建立关联

3. **RAG 深度搜索策略**
   - 浅层搜索：只查粗粒度层（摘要），用于日常对话
   - 深度搜索：展开细粒度层（详细素材），用于需要具体细节时
   - 触发条件：关键词检测 / 相似度阈值 / 手动指定（待确定）

4. **新会话初始化**
   - 只展示粗粒度摘要（简洁）
   - 细粒度素材保存在库中，供 RAG 检索使用

5. **术语优化**
   - "对话历史" → "会话文件"（更准确）
   - "父子结构" → "分层摘要"（v0.3.2 修正）

**设计优势**：
- ✅ 延续历史（摘要）+ 可复用剧情素材（详细）两全其美
- ✅ 一次 LLM 调用完成，不需要多次调用
- ✅ 新会话简洁，RAG 可按需获取详细内容
- ✅ 详细素材可被导演模块、剧情设计等功能复用

**技术可行性**：
- ✅ LLM 结构化输出（JSON）：完全可行
- ✅ Chroma 分层摘要存储：完全可行
- ✅ RAG 深度搜索：完全可行

**文档更新**：
- DESIGN_OVERVIEW.md v0.3.0 → v0.3.1 → v0.3.2（逻辑修复）

### 2025-10-15 01:00 - 完成 DESIGN_OVERVIEW.md（概要设计）✅

**重大调整**：
1. **文档定位调整**
   - 删除旧的 DESIGN.md（详细设计，1114 行）
   - 创建新的 DESIGN_OVERVIEW.md（概要设计）
   - 原因：详细设计修改成本高，频繁修改等于摧毁项目
   - 策略：只写架构框架和核心流程，不写具体实现

2. **核心架构重新设计**
   - ❌ 取消 RecallMemoryCache（内存缓存）
   - ❌ 取消 Core Memory 定期自动更新
   - ❌ 取消事件定期自动写入
   - ❌ 取消"最近 30 轮"的限制
   - ✅ 改为：全量读取对话历史
   - ✅ 改为：完全手动触发（汇总、更新记忆）
   - ✅ 新增：汇总功能（独立 LLM Agent，生成多段情节摘要）
   - ✅ 新增：回退重新生成功能

3. **术语统一**
   - Recall Memory → 对话历史（Conversation History）
   - Core Memory → 角色状态（Character State）
   - Archival Memory → 事件库（Event Library）

4. **设计原则明确**
   - 单一数据源（避免同步问题）
   - 完全手动触发（用户控制）
   - 预留扩展性（摘要格式待定）
   - 纯定性描述（不用量化数值）

**设计核心变化**：
- **Recall Memory**: 全量读取所有对话（不限制数量）
- **汇总功能**: 独立 LLM Agent，Prompt：「请把以下对话按照情节点进行汇总」
- **汇总结果**: 多段分段的纯文本，每段分别写入 Chroma
- **新会话初始化**: 汇总摘要 + 最后5轮对话（顺序可配置）
- **RAG 作用**: 跨多次汇总检索历史事件

**文档归档**：
- 旧的 DESIGN.md → `docs/archive/v0.2.0/DESIGN_DETAIL.md`
- 新的 DESIGN_OVERVIEW.md → `docs/DESIGN_OVERVIEW.md`

### 2025-10-15 00:15 - 修正目录结构错误 ✅

**调整内容**:
1. **删除不必要的 tests/ 目录**
   - 项目还未开始编码，不需要正式测试目录
   - 删除空的 `./tests/` 目录
   - 以后开发时才创建正式的 tests/ 目录

2. **明确 temp/ 目录的使用规则**
   - `temp/tests/` - 用于临时测试代码
   - `temp/reports/` - 用于临时分析报告
   - temp/ 目录不提交到 Git
   - 规范已定义但之前从未使用过

**问题发现**:
- tests/ 和 temp/tests/ 重复，但项目还未开始编码
- temp/ 目录设计了但从未使用过（自我反省）
- 需要严格遵守规范.md 中的文件位置规范

### 2025-10-15 00:05 - 完善项目管理规范与文档归档 ✅

**调整内容**:
1. **完成 v0.2.0 版本文档归档**
   - 归档核心文档：PROJECT_STATUS.md, DESIGN.md, REQUIREMENTS.md, README.md, CHANGELOG.md
   - 归档位置：`docs/archive/v0.2.0/`

2. **改进版本发布规范** - 新增临时文件清理步骤
   - 在 `规范.md` 的"版本发布"流程中新增步骤 6：清理临时文件
   - 规则：检查 `docs/` 下的临时问题文档（*_ISSUES.md, *_FIXES_NEEDED.md 等）
   - 已修复的问题文档 → 移动到 `docs/archive/v{版本号}/issues/`
   - 活跃的问题文档（如 QUESTIONS.md）→ 保留在 `docs/`
   - 发布时询问用户是否需要保留 `temp/` 目录内容

3. **清理已修复的问题文档**
   - 移动 DESIGN_ISSUES.md 到 `docs/archive/v0.2.0/issues/`（✅ 已全部修复）
   - 移动 CRITICAL_FIXES_NEEDED.md 到 `docs/archive/v0.2.0/issues/`（✅ 已全部修复）
   - 保留 QUESTIONS.md 在 `docs/`（仍有未解决的设计问题）

4. **优化项目管理工作流**
   - 归档不仅保存核心文档，还保存设计过程中的问题文档（作为历史记录）
   - 避免已解决的问题文档永久保留在 `docs/` 造成混乱
   - 建立清晰的文档生命周期：活跃 → 归档 → 不再干扰当前工作

**改进原因**:
- 发现已修复的问题文档（DESIGN_ISSUES.md, CRITICAL_FIXES_NEEDED.md）仍在 `docs/` 目录
- 原有的"版本发布"规范中缺少清理临时文件的步骤
- 需要明确区分"活跃文档"和"历史文档"

### 2025-10-14 23:00 - 启动系统运作机制总览梳理 🔄

**背景**：
发现当前设计文档中，各个机制的描述是分散的、局部的，缺少一个端到端的完整流程图。导致在设计"拉回主线"和"升级机制"这两个细节时，容易与其他机制冲突，导致返工。

**决定**：
先暂停细节设计，梳理完整的系统运作机制总览，包括：
1. 完整交互流程（从用户输入到AI回复的每一步）
2. 关键时机的决策树（何时触发各种机制）
3. Prompt组装的完整规则（不同情况下的结构变化）
4. 状态变更的传播路径（内存/持久化/触发链）

**工作流程调整**：
- 每完成一步，停下来与用户讨论确认，再进入下一步
- 避免自作主张连续完成所有步骤

**当前进度**：
- [ ] 第一步：完整交互流程（待与用户确认）

### 2025-10-14 21:30 - UI布局修正与功能清单整理 ✅

**调整内容**:
1. **UI 布局设计修正** - 修正三栏布局理解错误
   - 正确设计：左、中、右三个区域都从顶到底
   - 中间区域内部分为：顶部功能栏 + 对话消息区 + 用户输入框
   - 顶部功能栏与输入框面积相同
   - 已更新 REQUIREMENTS.md v2.2 和 DESIGN.md v0.2.1

2. **基础功能清单整理** - 明确必备功能范围
   - 核心功能：角色/背景/会话实例管理（CRUD）+ 对话功能
   - 基础功能：导入导出、角色状态查看、角色编辑
   - 添加到 REQUIREMENTS.md 新章节

3. **后台管理端功能明确** - 划定功能边界
   - 必备功能：待处理事件、Core Memory 历史、系统配置、数据统计、数据管理
   - 明确不需要：查看/编辑会话实例状态（让 AI 自动维护）
   - 明确角色编辑在用户端（不是后台管理端）

4. **Prompt 组装引擎扩展性预留** - V1/V2 规划
   - V1：固定结构，硬编码，确保功能正常
   - V2：预留模板加载接口，支持可配置
   - 代码模块化，便于后续重构

5. **待讨论的严重问题** - 下次会话重点
   - 导演模块"拉回主线"的具体策略（Prompt 组装、注入位置）
   - 快动态层"升级"机制（LLM 判断、触发时机、性价比）

### 2025-10-14 20:00 - 需求澄清与设计细化 ✅

**调整内容**:
1. **完成需求澄清讨论** - 明确 9 个关键设计决策
   - 用户输入处理：统一处理，不做类型区分
   - `[PROGRESS]` 标记：允许 AI 自动判断，成功率约 70-80%
   - Core Memory 维护：提供手动触发功能（6-11秒）
   - 故事主线大纲：数量灵活，建议路线（不强制）
   - 导演模块拉回主线：手动触发功能，待设计具体策略
   - 快动态层：最多保留当前最重要的 5 个要素（不是最近 5 轮）
   - 并发存储：先按单用户实现，预留 SQLite
   - 事件写入失败：暂存机制 + 后台管理端重试
   - UI 布局：三栏布局（类似 ST），左右功能区垂直排列

2. **研究 SillyTavern 机制**
   - 保存研究资料到 `docs/research/SillyTavern_Prompt_Assembly.md`
   - 核心理解：ST 是 LLM 对话界面 + 灵活的 Prompt 组装引擎
   - World Info 使用关键词匹配，PersonaLab 使用向量检索（更智能）
   - 学习 ST 的分层注入策略和用户控制权设计

3. **文档更新**
   - 需求文档更新到 v2.2（添加需求澄清记录章节）
   - 设计文档更新到 v0.2.1（添加术语变更说明 + 新设计章节）
   - 明确术语：Storyline → Conversation Instance

4. **待设计的细节**
   - 导演模块"拉回主线"的具体策略和注入位置
   - 快动态层"升级"机制的性价比方案
   - 后台管理端的完整功能设计

### 2025-10-14 18:00 - 设计导演模块与会话实例机制 ✅

**调整内容**:
1. **设计导演模块（Director）** - 剧情推进控制机制
   - 三层控制机制：静态约束（主线大纲）+ 动态引导（[PROGRESS]标记）+ RAG兜底
   - 剧情状态管理：AI每次回复输出`[PROGRESS:X:status]`，后端正则扫描更新
   - 兜底机制：连续3轮未更新时触发RAG分层检索（当前实例15条 + 其他实例5条）
   - 剧情状态管理是导演模块的子功能之一，未来可扩展更多机制

2. **术语优化：故事线 → 会话实例**
   - 原名称"故事线（Storyline）"误导性强，容易与"剧情主线"混淆
   - 改为"会话实例（Conversation Instance）"，更准确表达本质：状态隔离容器
   - 数据库字段：`storyline_id` → `instance_id`
   - 核心作用：允许同一角色+背景创建多个实例，状态完全独立

3. **分层检索策略** - 解决需求矛盾
   - 需求矛盾：既想利用历史剧情经验帮助AI，又不想污染当前剧情一致性
   - 日常对话：只检索当前实例（20条），严格隔离
   - 导演兜底：跨实例检索，分两次查询（当前实例15条 + 其他实例5条）
   - Prompt分层展示：明确区分"当前剧情事实"和"剧情经验参考"
   - 技术验证：Chroma不支持boost权重，采用两次检索方案

4. **需求文档更新（v2.1）**
   - 全文统一术语：会话实例
   - 补充完整的分层检索代码示例
   - 明确两种RAG检索场景的不同策略

### 2025-10-14 15:30 - 完成需求文档编写 ✅

**调整内容**:
1. 创建 [docs/REQUIREMENTS.md](docs/REQUIREMENTS.md) - 需求文档
   - 明确项目定位：AI角色对话平台,类似Silly Tavern
   - 核心需求1：主线剧情执行与遵守 (10个节点放入Prompt头部4K)
   - 核心需求2：人格丰富性与成长 (借鉴Letta/MemGPT三层记忆架构)
   - 核心需求3：长会话延续性 (使用Conversational RAG优化世界书机制)
2. 需求文档采用"需求+设计方案"结构
   - 每个需求都包含具体的设计方案
   - 使用具体数值 (每10轮、最近5-10条、检索20条)
   - 完整解释所有概念,避免缩略
3. 研究并参考了Silly Tavern和Letta/MemGPT系统
   - Silly Tavern World Book: 基于关键词匹配最近N条消息
   - Letta/MemGPT: 三层记忆架构 (Core/Archival/Recall Memory)
   - 采用Conversational RAG替代简单关键词匹配
4. 讨论AI协作规范的可执行性
   - 分析了AI无法自动执行的规范类型 (主观判断、自动触发)
   - 确认只有用户可验证的操作规范才可执行 (项目管理操作)

### 2025-10-14 - 架构重新设计 ✅

**重大调整**：
1. **引入故事线（Storyline）架构**
   - 解决原设计的状态污染问题
   - 角色状态从全局改为故事线级别
   - 一个故事线内可以有多个会话（支持暂停/继续）

2. **简化人格三层机制**
   - 删除所有量化数值（priority, intensity, level）
   - 改为纯定性描述 + timestamp
   - 用定期维护任务清理，而非数字降级

3. **简化事件库设计**
   - 删除事件链表（previous_event）
   - 改为纯RAG语义检索
   - 必须记录storyline_id和session_id
   - RAG检索时必须过滤storyline_id

4. **删除过度设计**
   - 删除归档机制（archived标记）
   - 删除会话摘要（session_summary）
   - 删除事件双层结构（会话事件+全局事件）
   - 删除数字降级机制（每N轮-1）

5. **性能优化**
   - 异步并行加载（asyncio.gather）
   - RAG超时保护（1.5秒）
   - 异步写入事件（不阻塞返回）
   - 总耗时：~2秒（非LLM）+ ~18秒（LLM）≈ 20秒 ✅

**设计原则确认**：
- ✅ 故事线隔离状态
- ✅ 纯定性描述，无量化
- ✅ 定期维护任务清理数据
- ✅ 事件库带storyline_id过滤
- ✅ 性能目标：总耗时 < 30秒

### 2025-10-13 - 完成初版技术设计 ✅

**调整内容**:
1. 明确系统总目标：解决LLM长对话中的上下文稀释和指令遗忘问题
2. 设计核心数据结构（已在v0.2.0中重构）
3. 确定核心机制（已在v0.2.0中简化）
4. 设计Prompt工程：模块化、可配置
5. 明确技术栈：后端 Python + FastAPI + LangChain + Chroma

---

## 📋 待办事项

### 高优先级（设计阶段）

- [x] 完成核心技术设计（DESIGN.md v0.2.0）
- [x] 解决架构层面的设计问题
- [x] 确定数据结构细节
- [x] 完成需求文档（REQUIREMENTS.md）
- [ ] **设计导演模块"拉回主线"具体策略**
  - 用户点击"🎬 拉回主线"后，后端如何组装 Prompt？
  - 信息应该插入到哪个位置（头部 4K / 中间 / 尾部）？
  - 需要注入什么内容（当前大纲点 + RAG 事件 + 特殊指令）？
  - 如何让 AI 自然地将剧情引导回主线（而不是生硬重置）？
- [ ] **设计快动态层"升级"机制**
  - LLM 如何判断一个状态需要升级到慢动态层？
  - 升级的触发时机（每 10 轮维护时？还是单独任务？）
  - 如何保证性价比（不过度调用 LLM，避免增加太多成本）？
  - 是否需要设置升级条件（如状态持续 N 轮以上）？
- [ ] 设计后端API接口规范（基于会话实例架构）

### 高优先级（后端实现）

- [ ] 搭建FastAPI项目结构
- [ ] 实现数据模型（Pydantic）
- [ ] 实现StateManager（三层人格状态管理）
- [ ] 实现EventManager（RAG + Chroma + 分层检索）
- [ ] 实现Director（导演模块：剧情状态管理 + RAG兜底）
- [ ] 实现PromptEngine（Prompt组装）
- [ ] 实现LLMService（LangChain集成）
- [ ] 实现InteractionLoop（核心交互流程）
- [ ] 实现定期维护任务
- [ ] 实现REST API（会话实例/角色/背景CRUD）
- [ ] 实现WebSocket（流式对话）

### 高优先级（前端实现）

- [ ] 创建Next.js项目结构
- [ ] 生成TypeScript类型定义（基于新架构）
- [ ] 生成API客户端封装（会话实例API）
- [ ] 生成WebSocket管理
- [ ] 生成Shadcn UI基础组件
- [ ] 生成布局组件
- [ ] 生成会话实例管理组件
- [ ] 生成对话功能组件
- [ ] 生成角色管理组件
- [ ] 生成背景管理组件
- [ ] 生成页面路由 

### 中优先级

- [ ] Prompt模板前端管理功能
- [ ] 会话实例导出功能
- [ ] 角色状态展示
- [ ] 添加加载状态和错误处理
- [ ] 响应式布局优化

### 低优先级

- [ ] 编写组件文档
- [ ] 添加单元测试
- [ ] 性能监控和优化

---

## ⚙️ 强制性开发规范

### 1. 文件位置规范

| 文件类型 | 存放位置 | 示例 |
|---------|---------|------|
| 临时测试文件 | `temp/tests/` | test_*.* |
| 临时报告文件 | `temp/reports/` | *_report.md |
| 版本发布报告 | `docs/reports/` | v{版本号}_release_report.md |
| 归档文档 | `docs/archive/v{版本号}/` | PROJECT_STATUS.md 等 |
| 核心文档 | 项目根目录 | PROJECT_STATUS.md, README.md, CHANGELOG.md, 规范.md |
| 前端源代码 | `frontend/src/` | *.ts, *.tsx |
| 后端源代码 | `backend/app/` | *.py |
| 正式测试 | `tests/` | test_*.* |

### 2. 设计原则（关键）

**绝对禁止量化**：
- ❌ 不使用 priority, intensity, level, score 等数字
- ❌ 不使用"每N轮-1"的降级机制
- ❌ 不使用数字阈值判断删除

**纯定性描述**：
- ✅ 所有内容都是文本描述
- ✅ 用 timestamp 记录时间
- ✅ 用定期维护任务清理数据

---

## 🤝 AI 协作指南

### 基本原则

1. **归档文档是历史快照**：`docs/archive/` 不代表最新状态
2. **问题查阅顺序**：PROJECT_STATUS.md → DESIGN.md → 规范.md
3. **设计原则**：纯定性描述，绝对禁止量化

### 操作规范

**执行项目管理操作时，参考 `规范.md`**：
- 归档：`按照规范归档`
- 重构：`按照规范重构`
- 版本发布：`按照规范发布`
- 更新PS：`按照规范更新PS` 或 `更新PS`

---

## 🎯 下一步计划

### 短期目标（1-2周）

1. 设计后端API接口规范（基于会话实例架构）
2. 搭建FastAPI后端项目结构
3. 实现核心模块（StateManager, EventManager, PromptEngine）
4. 实现基础REST API

### 中期目标（3-4周）

1. 完成后端核心功能实现
2. 搭建Next.js前端项目
3. 实现前端核心UI组件
4. 前后端联调

### 长期目标（1-2月）

1. 完成V1.0功能开发
2. 测试和优化
3. 编写用户文档
4. 准备发布

---

**文档版本**: v0.2.0
**创建日期**: 2025-10-13
**最后更新**: 2025-10-15
